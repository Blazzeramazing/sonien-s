<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="SONIEN'S - Alta Costura e Design Autoral">
    <title>SONIEN'S | Alta Costura</title>
    
    <!-- Favicon baseado no Selo SONIEN'S -->
    <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="%230d0c0b" /><circle cx="50" cy="50" r="40" fill="none" stroke="%23f5eedc" stroke-width="3"/><circle cx="50" cy="50" r="25" fill="none" stroke="%23f5eedc" stroke-width="3"/><line x1="50" y1="10" x2="50" y2="90" stroke="%23f5eedc" stroke-width="3"/><text x="50" y="68" font-family="serif" font-size="48" fill="%23f5eedc" text-anchor="middle" font-weight="bold">S</text></svg>'>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Fonts OTIMIZADAS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400&family=Marcellus&family=Space+Mono:wght@400&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- REMOVER BARRA DE ROLAGEM GLOBALMENTE --- */
        ::-webkit-scrollbar {
            display: none; /* Chrome, Safari e Opera */
            width: 0px;
            background: transparent;
        }
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE e Edge */
        }

        :root {
            --cursor-size: 10px;
            --cursor-trail-size: 40px;
            --primary: #f5eedc; 
            --accent: #d4af37; 
            --bg-color: #0d0c0b; 
            --glass-border: rgba(245, 238, 220, 0.15);
            --mx: 0; 
            --my: 0;
        }

        /* OTIMIZAÇÃO DE TRANSIÇÃO: Permite que a mudança de tema (Cores) seja suave */
        body, #dedicated-page, .modal-content {
            transition: background-color 1s ease, color 1s ease;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--primary);
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            height: 100vh; width: 100vw;
            cursor: none !important;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        ::selection {
            background-color: var(--accent);
            color: #fff;
        }

        :focus-visible {
            outline: 1px solid var(--accent);
            outline-offset: 4px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .font-display { font-family: 'Marcellus', serif; }
        .font-tech { font-family: 'Syncopate', sans-serif; }
        .font-mono { font-family: 'Space Mono', monospace; }

        a, button, .cursor-pointer, .project-card-3d, .hover-trigger, select, input, textarea {
            cursor: none !important;
        }

        .magnetic-btn {
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
            will-change: transform;
        }

        #viewport {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            perspective: 1000px;
            overflow: hidden; pointer-events: none; 
            transition: opacity 1s ease;
        }

        section {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; 
            visibility: hidden; 
            transform-style: preserve-3d;
            will-change: transform, opacity;
        }

        section.active-section {
            pointer-events: auto;
            z-index: 40;
        }

        #work, #about, #contact, #footer-section { padding-top: 0; }

        nav, .hud-element, #hud-nav {
            position: fixed; z-index: 50;
            transition: opacity 1s ease;
        }

        #nav-links, #nav-cta {
            transition: opacity 2s ease, transform 2s ease;
        }

        #mobile-menu {
            position: fixed; inset: 0;
            background: rgba(var(--bg-color), 0.98); 
            backdrop-filter: blur(20px); z-index: 49;
            transform: translateY(-100%);
            transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #mobile-menu.open { transform: translateY(0); }

        .hamburger-line { 
            width: 24px; height: 1px; background-color: var(--primary); 
            transition: transform 0.4s cubic-bezier(0.86, 0, 0.07, 1), background-color 1s ease; 
        }
        #hamburger-btn.open .hamburger-line:first-child { transform: rotate(45deg) translate(5px, 5px); }
        #hamburger-btn.open .hamburger-line:last-child { transform: rotate(-45deg) translate(5px, -5px); }

        .noise-overlay {
            position: fixed; top: -50px; left: -50px; right: -50px; bottom: -50px;
            pointer-events: none; z-index: 9000; opacity: 0.04;
            /* OTIMIZADO: Tamanho de bloco fixo (256px) no SVG para impedir costuras visíveis (seams) no centro do ecrã */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' width='256' height='256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            animation: analogNoise 0.4s steps(1) infinite;
            will-change: transform, opacity; 
        }
        @keyframes analogNoise {
            0%, 100% { transform: translate(0, 0); opacity: 0.03; }
            20% { transform: translate(-2px, 2px); opacity: 0.05; }
            40% { transform: translate(-2px, -2px); opacity: 0.04; }
            60% { transform: translate(2px, 2px); opacity: 0.06; }
            80% { transform: translate(2px, -2px); opacity: 0.03; }
        }

        /* EFEITO ATMOSFÉRICO DE FUMAÇA */
        @keyframes smokeDrift {
            0% { transform: translate3d(0, 0, 0) scale(2); opacity: 0.05; }
            50% { opacity: 0.15; }
            100% { transform: translate3d(-5%, -15%, 0) scale(2.5); opacity: 0.05; }
        }
        .animate-smoke {
            animation: smokeDrift 20s ease-in-out infinite alternate;
            will-change: transform; 
            background-size: cover;
            background-repeat: no-repeat;
            /* OTIMIZADO: Resolução definida de 1024px para evitar quebras quando esticado na tela inteira */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1024 1024' width='1024' height='1024' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.005' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .cursor-dot, .cursor-trail {
            display: none; position: fixed; top: 0; left: 0;
            border-radius: 50%; z-index: 10005; pointer-events: none;
            mix-blend-mode: difference;
            will-change: transform;
        }
        
        .cursor-dot {
            width: var(--cursor-size); height: var(--cursor-size);
            background-color: var(--primary); 
            transition: background-color 0.2s;
        }

        .cursor-trail {
            width: var(--cursor-trail-size); height: var(--cursor-trail-size);
            border: 1px solid rgba(245, 238, 220, 0.5); 
            transition: width 0.3s, height 0.3s, border-color 0.3s;
            z-index: 10004;
        }

        @media (hover: hover) and (pointer: fine) { 
            .cursor-dot, .cursor-trail { display: block; } 
        }

        .solar-text-container { position: relative; display: inline-block; }
        .solar-text { opacity: 0 !important; visibility: hidden !important; }
        .solar-text.solar-active { opacity: 1 !important; visibility: visible !important; transition: opacity 0.1s; }
        .solar-spark { color: var(--primary); text-shadow: 0 0 12px var(--accent); opacity: 1 !important; }
        .solar-dim { opacity: 0.3; color: var(--accent); transition: color 1s ease; }

        .carousel-3d-wrapper {
            position: relative; width: 100%; 
            height: 350px; perspective: 2000px; 
            display: flex; justify-content: center; align-items: center;
        }
        @media(min-width: 768px) { .carousel-3d-wrapper { height: 500px; } }

        .carousel-3d-stage {
            position: relative; width: 240px; height: 340px; 
            transform-style: preserve-3d;
        }
        .project-card-3d {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 12, 11, 0.95); border: 1px solid var(--glass-border);
            padding: 1.5rem; display: flex; flex-direction: column;
            cursor: none !important; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); backface-visibility: hidden; 
            overflow: hidden; user-select: none; -webkit-user-drag: none;
        }
        @media(min-width: 768px) {
            .carousel-3d-stage { width: 340px; height: 460px; }
            .project-card-3d { padding: 2rem; }
        }
        .project-card-3d:hover {
            border-color: var(--accent);
            box-shadow: 0 0 40px var(--accent);
            transform: scale(1.02);
        }
        .card-image-container {
            width: 100%; height: 150px; background: #111;
            overflow: hidden; margin-bottom: 1rem; position: relative; flex-shrink: 0;
        }
        @media(min-width: 768px) { .card-image-container { height: 240px; } }

        .card-image-container img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), filter 0.8s;
            filter: grayscale(80%) sepia(20%) brightness(0.8) url(#liquid-filter); 
            -webkit-user-drag: none;
            transform: scale(1.05) translate(calc(var(--mx, 0) * -12px), calc(var(--my, 0) * -12px));
            will-change: transform, filter;
        }
        .project-card-3d:hover .card-image-container img {
            transform: scale(1.15) translate(calc(var(--mx, 0) * -18px), calc(var(--my, 0) * -18px));
            filter: grayscale(0%) sepia(10%) brightness(1) url(#liquid-filter);
        }

        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s cubic-bezier(0.86, 0, 0.07, 1);
        }
        .loader-bar {
            width: 0%; height: 1px; background: var(--accent);
            transition: width 0.1s linear, background-color 1s ease; box-shadow: 0 0 15px var(--accent); 
        }

        #isekai-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; overflow-x: hidden;
            background: rgba(13, 12, 11, 0.95); border: 1px solid rgba(245,238,220,0.1);
            backdrop-filter: blur(20px); z-index: 9999; padding: 2.5rem; opacity: 0; pointer-events: none;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9); transition: all 0.7s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #isekai-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        .isekai-btn {
            background: transparent; border: 1px solid var(--accent); color: var(--primary); 
            padding: 1rem 2rem; font-family: 'Syncopate', sans-serif; font-size: 0.7rem; 
            letter-spacing: 0.2em; cursor: pointer; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            width: 100%; margin-top: 2rem; position: relative; overflow: hidden;
        }
        .isekai-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--accent); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: -1;
        }
        .isekai-btn:hover { color: #000; box-shadow: 0 0 30px var(--accent); }
        .isekai-btn:hover::before { transform: translateX(100%); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); 
            z-index: 10001; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease; padding: 20px;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto !important; }

        .modal-content {
            background: var(--bg-color); border: 1px solid rgba(245,238,220,0.1); max-width: 1000px; width: 100%; 
            max-height: 90vh; overflow-y: auto; overflow-x: hidden; position: relative;
            transform: translateY(30px) scale(0.98); transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        @media(min-width: 768px) { .modal-content { flex-direction: row; } }
        .modal-overlay.open .modal-content { transform: translateY(0) scale(1); }

        .form-input {
            width: 100%; background: transparent; border-bottom: 1px solid rgba(245,238,220,0.2);
            border-top: 0; border-left: 0; border-right: 0; padding: 1rem 0; color: var(--primary); 
            font-family: 'Inter', sans-serif; transition: border-color 0.3s; outline: none; border-radius: 0; 
        }
        .form-input:focus { border-color: var(--accent); }

        .hud-element {
            position: fixed; z-index: 8000; font-family: 'Space Mono', monospace;
            color: rgba(245, 238, 220, 0.4); font-size: 9px; pointer-events: none; letter-spacing: 2px;
            text-transform: uppercase;
        }
        .hud-bl { bottom: 30px; left: 30px; }
        .hud-br { bottom: 30px; right: 30px; text-align: right; }
        .hud-tl { display: none; top: 100px; left: 30px; writing-mode: vertical-rl; transform: rotate(180deg); }
        @media(min-width: 768px) { .hud-tl { display: block; } }

        .dot-inner.active {
            background-color: var(--accent);
            transform: scale(2);
            box-shadow: 0 0 10px var(--accent);
        }

        #flash-overlay {
            position: fixed; inset: 0; background: var(--primary); z-index: 9998;
            opacity: 0; pointer-events: none; display: none;
            transition: background-color 1s ease;
        }

        .footer-shine-text {
            color: transparent; 
            -webkit-text-stroke: 1px rgba(245, 238, 220, 0.2);
            background: linear-gradient(110deg, transparent 35%, var(--accent) 50%, transparent 65%);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text;
            animation: textShine 6s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            opacity: 0.9;
        }
        
        .hero-shine-text {
            color: transparent; 
            -webkit-text-stroke: 2px rgba(245, 238, 220, 0.3);
            background: linear-gradient(110deg, transparent 35%, var(--accent) 50%, transparent 65%);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text;
            animation: textShine 6s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            opacity: 0.9;
            will-change: transform, background-position;
            transform: translateZ(0); 
        }

        @keyframes textShine { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }

        @media screen and (min-width: 1366px) and (max-width: 1920px) {
            #service-img-right {
                z-index: 20 !important;
                pointer-events: none !important; 
            }
        }

        .holo-container { position: relative; overflow: hidden; opacity: 0; }
        .holo-active { animation: holoFadeIn 0.1s linear forwards; }
        .holo-active .holo-mask { animation: holoScan 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .holo-scanline {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent); box-shadow: 0 0 15px 2px var(--accent); z-index: 30; opacity: 0;
            transition: background-color 1s ease, box-shadow 1s ease;
        }
        .holo-active .holo-scanline { animation: holoScanlineMove 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .holo-border-line { position: absolute; background: var(--accent); box-shadow: 0 0 8px var(--accent); opacity: 0; transition: background-color 1s ease; }
        .line-top { top: 0; left: 0; width: 100%; height: 1px; transform: translateX(-100%); }
        .line-right { top: 0; right: 0; width: 1px; height: 100%; transform: translateY(-100%); }
        .line-bottom { bottom: 0; right: 0; width: 100%; height: 1px; transform: translateX(100%); }
        .line-left { bottom: 0; left: 0; width: 1px; height: 100%; transform: translateY(100%); }
        .holo-active .line-top { animation: snakeTop 2s linear 1.4s infinite; opacity: 1; }
        .holo-active .line-right { animation: snakeRight 2s linear 1.9s infinite; opacity: 1; }
        .holo-active .line-bottom { animation: snakeBottom 2s linear 2.4s infinite; opacity: 1; }
        .holo-active .line-left { animation: snakeLeft 2s linear 2.9s infinite; opacity: 1; }

        @keyframes holoFadeIn { to { opacity: 1; } }
        @keyframes holoScan {
            0% { height: 0%; filter: brightness(2) contrast(1.5) grayscale(1); }
            100% { height: 100%; filter: brightness(1) contrast(1) grayscale(0); }
        }
        @keyframes holoScanlineMove { 0% { bottom: 0%; opacity: 1; } 95% { opacity: 1; } 100% { bottom: 100%; opacity: 0; } }
        @keyframes snakeTop { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes snakeRight { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        @keyframes snakeBottom { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes snakeLeft { 0% { transform: translateY(100%); } 100% { transform: translateY(-100%); } }

        @keyframes aetherFloat { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-12px) scale(1.03); } }
        .aether-float { animation: aetherFloat 6s ease-in-out infinite; }

        .brand-logo-text {
            font-family: 'Marcellus', serif;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="antialiased hidden-overflow no-scroll selection:bg-white selection:text-black">

    <h1 class="sr-only">SONIEN'S Alta Costura - Experiência Interativa 3D</h1>

    <svg style="width:0; height:0; position:absolute;" aria-hidden="true" focusable="false">
        <defs>
            <filter id="liquid-filter">
                <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="0" xChannelSelector="R" yChannelSelector="G" id="liquid-map" />
            </filter>
        </defs>
    </svg>

    <div class="hud-element hud-bl" aria-hidden="true">
        <div id="hud-coords">COLEÇÃO: ESSÊNCIA</div>
        <div>ALFAIATARIA: <span id="network-status" style="color: var(--accent); transition: color 1s ease;">PREMIUM</span></div>
    </div>
    <div class="hud-element hud-br" aria-hidden="true">
        <div>ATELIER: <span id="crystal-count">ABERTO</span></div>
        <div>ESTADO: <span id="hud-status">INATIVO</span></div>
    </div>
    <div class="hud-element hud-tl" aria-hidden="true">
        SONIEN'S // ALTA COSTURA
    </div>

    <nav id="hud-nav" aria-label="Navegação Rápida" class="fixed right-8 top-1/2 -translate-y-1/2 z-50 hidden md:flex flex-col items-center gap-10 opacity-0 transition-opacity duration-1000 pointer-events-none">
        <div class="absolute top-0 bottom-0 w-[1px] bg-white/10 left-1/2 -translate-x-1/2 -z-10"></div>
        
        <div tabindex="0" role="button" aria-label="Ir para Início" class="hud-dot relative cursor-pointer group hover-trigger p-2" onclick="SoundManager.playClick(); window.scrollToSection(0)" onkeydown="if(event.key==='Enter') this.click()">
            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-[9px] font-mono tracking-widest text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap uppercase pointer-events-none">Início</span>
            <div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-500 dot-inner" data-z="0"></div>
        </div>
        <div tabindex="0" role="button" aria-label="Ir para Coleções" class="hud-dot relative cursor-pointer group hover-trigger p-2" onclick="SoundManager.playClick(); window.scrollToSection(1000)" onkeydown="if(event.key==='Enter') this.click()">
            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-[9px] font-mono tracking-widest text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap uppercase pointer-events-none">Coleções</span>
            <div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-500 dot-inner" data-z="1000"></div>
        </div>
        <div tabindex="0" role="button" aria-label="Ir para O Atelier" class="hud-dot relative cursor-pointer group hover-trigger p-2" onclick="SoundManager.playClick(); window.scrollToSection(2000)" onkeydown="if(event.key==='Enter') this.click()">
            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-[9px] font-mono tracking-widest text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap uppercase pointer-events-none">O Atelier</span>
            <div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-500 dot-inner" data-z="2000"></div>
        </div>
        <div tabindex="0" role="button" aria-label="Ir para Contacto" class="hud-dot relative cursor-pointer group hover-trigger p-2" onclick="SoundManager.playClick(); window.scrollToSection(3000)" onkeydown="if(event.key==='Enter') this.click()">
            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-[9px] font-mono tracking-widest text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap uppercase pointer-events-none">Contacto</span>
            <div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-500 dot-inner" data-z="3000"></div>
        </div>
        <div tabindex="0" role="button" aria-label="Ir para o Fim da Página" class="hud-dot relative cursor-pointer group hover-trigger p-2" onclick="SoundManager.playClick(); window.scrollToSection(4000)" onkeydown="if(event.key==='Enter') this.click()">
            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-[9px] font-mono tracking-widest text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap uppercase pointer-events-none">Fim</span>
            <div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-all duration-500 dot-inner" data-z="4000"></div>
        </div>
    </nav>

    <div id="preloader">
        <div class="flex flex-col items-center z-10 px-4 text-center">
            <h1 class="text-4xl md:text-6xl mb-6 brand-logo-text text-white">SONIEN'S</h1>
            <div class="flex flex-col items-center w-64">
                <div class="w-full h-[1px] bg-gray-800 overflow-hidden mb-2 relative">
                    <div id="loader-bar" class="loader-bar absolute top-0 left-0"></div>
                </div>
                <div class="flex justify-between w-full text-[10px] font-mono text-gray-500 uppercase" aria-live="polite">
                    <span>A Preparar Coleção</span>
                    <span id="loader-percent">0%</span>
                </div>
            </div>
        </div>
    </div>

    <div id="flash-overlay"></div>

    <div id="isekai-modal" role="dialog" aria-modal="true" aria-labelledby="isekai-title">
        <div class="flex justify-between border-b border-white/10 pb-4 mb-6 text-[10px] font-mono tracking-widest text-gray-400 uppercase">
            <span>Manifesto_Marca</span>
            <span style="color: var(--accent); transition: color 1s ease;">Est. 2026</span>
        </div>
        <div class="font-display text-2xl md:text-4xl leading-relaxed text-gray-200 mb-8 w-full text-center md:text-left whitespace-normal">
            <p id="isekai-text" class="solar-text" data-value="A verdadeira elegância é atemporal. 
Onde a criatividade encontra o estilo, nós forjamos a sua identidade."></p>
        </div>
        <div class="flex justify-center md:justify-end">
            <button tabindex="0" id="enter-world-btn" aria-label="Descobrir Coleção" class="isekai-btn hover-trigger solar-text magnetic-btn" data-value="DESCOBRIR COLEÇÃO">DESCOBRIR COLEÇÃO</button>
        </div>
    </div>

    <canvas id="webgl-canvas" aria-hidden="true" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>
    
    <div class="noise-overlay"></div>

    <div class="cursor-dot" aria-hidden="true"></div>
    <div class="cursor-trail" aria-hidden="true"></div>

    <div id="mobile-menu" aria-hidden="true">
        <a tabindex="0" href="#" class="text-4xl brand-logo-text mb-8 mobile-link solar-text text-white hover-trigger magnetic-btn" data-nav-to="1000" data-value="Coleções">Coleções</a>
        <a tabindex="0" href="#" class="text-4xl brand-logo-text mb-8 mobile-link solar-text text-white hover-trigger magnetic-btn" data-nav-to="2000" data-value="O Atelier">O Atelier</a>
        <a tabindex="0" href="#" class="text-4xl brand-logo-text mb-8 mobile-link solar-text text-white hover-trigger magnetic-btn" data-nav-to="3000" data-value="Contacto">Contacto</a>
    </div>

    <nav class="fixed top-0 w-full p-6 md:p-10 flex justify-between items-center z-50 opacity-0" id="main-nav" aria-label="Navegação Principal">
        <div tabindex="0" role="button" aria-label="Ir para o Início" class="text-2xl font-bold brand-logo-text hover-trigger z-50 cursor-pointer magnetic-btn flex items-center gap-3" onclick="SoundManager.playClick(); window.scrollToSection(0)" onkeydown="if(event.key==='Enter') this.click()">
            <svg class="w-6 h-6" viewBox="0 0 100 100" aria-hidden="true">
                <circle cx="50" cy="50" r="48" fill="transparent" stroke="currentColor" stroke-width="2"/>
                <circle cx="50" cy="50" r="35" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="2"/>
                <text x="50" y="65" font-family="serif" font-size="40" fill="currentColor" text-anchor="middle" font-weight="bold">S</text>
            </svg>
            <span style="letter-spacing: 0.15em;">SONIEN'S</span>
        </div>
        
        <div id="nav-links" class="hidden md:flex gap-12 font-mono text-[10px] tracking-widest text-gray-400 opacity-0 pointer-events-none uppercase">
            <a tabindex="0" href="#" class="hover:text-[var(--primary)] transition-colors hover-trigger magnetic-btn solar-text" data-value="Coleções" onclick="SoundManager.playClick(); window.scrollToSection(1000)">Coleções</a>
            <a tabindex="0" href="#" class="hover:text-[var(--primary)] transition-colors hover-trigger magnetic-btn solar-text" data-value="O Atelier" onclick="SoundManager.playClick(); window.scrollToSection(2000)">O Atelier</a>
            <a tabindex="0" href="#" class="hover:text-[var(--primary)] transition-colors hover-trigger magnetic-btn solar-text" data-value="Contacto" onclick="SoundManager.playClick(); window.scrollToSection(3000)">Contacto</a>
        </div>
        
        <button tabindex="0" id="nav-cta" aria-label="Agendar Prova" class="hidden md:block border border-white/20 px-6 py-2 rounded-full text-[10px] font-mono tracking-widest hover:bg-[var(--primary)] hover:text-[var(--bg-color)] transition-colors duration-500 hover-trigger open-contact-btn opacity-0 pointer-events-none magnetic-btn uppercase solar-text" data-value="Agendar Prova">
            Agendar Prova
        </button>

        <button tabindex="0" id="hamburger-btn" aria-label="Abrir Menu" aria-expanded="false" class="md:hidden z-50 flex flex-col gap-1.5 p-4 -m-4 hover-trigger magnetic-btn">
            <div class="hamburger-line origin-center"></div>
            <div class="hamburger-line origin-center"></div>
        </button>
    </nav>

    <div id="viewport" aria-live="polite">
        <section class="section-3d" data-z="0" aria-label="Secção Inicial">
            <div class="flex flex-col justify-center items-center px-6 text-center max-w-5xl">
                <p class="font-mono text-gray-400 mb-6 text-xs tracking-[0.5em] solar-text uppercase" data-value="ALTA COSTURA & DESIGN">ALTA COSTURA & DESIGN</p>
                
                <div class="flex flex-col items-center mb-8 relative z-10 w-full">
                    <h2 class="brand-logo-text text-[15vw] leading-[0.9] solar-text hero-shine-text" data-value="Sonien's">Sonien's</h2>
                    <p class="font-display italic text-[4vw] tracking-widest text-gray-300 mt-2 solar-text" data-value="A Essência do Estilo">A Essência do Estilo</p>
                </div>

                <p class="hidden md:block max-w-2xl mx-auto text-center text-sm text-gray-400 font-light leading-relaxed mt-6 solar-text" 
                   data-value="A convergência perfeita entre design autoral e materiais premium. Vestuário criado com mestria para transcender as tendências e celebrar a sua identidade.">
                    A convergência perfeita entre design autoral e materiais premium. Vestuário criado com mestria para transcender as tendências e celebrar a sua identidade.
                </p>

                <p class="block md:hidden max-w-xs mx-auto text-center text-xs text-gray-400 font-light leading-relaxed mt-4 solar-text" 
                   data-value="Sua Identidade Estampada com Estilo.">
                    Sua Identidade Estampada com Estilo.
                </p>
                
                <div class="absolute bottom-12 left-1/2 -translate-x-1/2">
                    <div tabindex="0" role="button" aria-label="Explorar Coleções" class="flex flex-col items-center gap-4 hover-trigger cursor-pointer magnetic-btn" onclick="SoundManager.playClick(); window.scrollToSection(1000)" onkeydown="if(event.key==='Enter') this.click()">
                        <span class="text-[9px] font-mono tracking-widest text-gray-500 uppercase">Explorar as Coleções</span>
                        <div class="w-[1px] h-12 bg-gradient-to-b from-[var(--accent)] to-transparent opacity-50 transition-colors duration-1000"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section-3d" data-z="1000" id="work" aria-label="Coleções de Assinatura">
            <div class="w-full flex flex-col items-center">
                <div class="flex flex-col justify-center items-center mb-8 md:mb-12 gap-2 px-6 text-center pt-16 md:pt-0">
                    <h2 class="text-4xl md:text-6xl font-display italic text-white solar-text" data-value="Peças de Assinatura">Peças de Assinatura</h2>
                    <p class="font-mono text-gray-500 text-xs tracking-widest uppercase solar-text" data-value="Coleções Exclusivas">Coleções Exclusivas</p>
                    <p class="md:hidden font-mono text-gray-600 mt-2 text-[9px] uppercase tracking-widest opacity-60">Arraste para explorar</p>
                </div>
                
                <div class="carousel-3d-wrapper" role="region" aria-label="Carrossel de Coleções. Use as setas esquerda e direita para navegar.">
                    <div class="carousel-3d-stage" id="carousel-stage"></div>
                </div>
            </div>
        </section>

        <section class="section-3d" data-z="2000" id="about" aria-label="O Nosso Atelier">
            <div id="service-img-left" class="holo-container hidden min-[1921px]:block absolute left-[10%] top-1/2 -translate-y-1/2 w-96 h-[32rem] border border-white/5 z-0 [perspective:1000px]" aria-hidden="true">
                <div class="holo-border-line line-top"></div><div class="holo-border-line line-right"></div>
                <div class="holo-border-line line-bottom"></div><div class="holo-border-line line-left"></div>
                <div class="holo-mask w-full h-full absolute bottom-0 left-0 overflow-hidden">
                    <div class="holo-scanline"></div>
                    <div class="service-img-inner w-full h-full transition-transform duration-100 ease-out">
                        <img src="" alt="" class="w-full h-full object-cover opacity-80 mix-blend-screen aether-float">
                    </div>
                </div>
            </div>

            <div id="service-img-right" class="holo-container hidden md:block absolute right-[10%] top-1/2 -translate-y-1/2 w-96 h-[32rem] border border-white/5 z-0 [perspective:1000px]" aria-hidden="true">
                <div class="holo-border-line line-top"></div><div class="holo-border-line line-right"></div>
                <div class="holo-border-line line-bottom"></div><div class="holo-border-line line-left"></div>
                <div class="holo-mask w-full h-full absolute bottom-0 left-0 overflow-hidden">
                    <div class="holo-scanline"></div>
                    <div class="service-img-inner w-full h-full transition-transform duration-100 ease-out">
                        <img src="" alt="" class="w-full h-full object-cover opacity-80 mix-blend-screen aether-float">
                    </div>
                </div>
            </div>

            <div class="max-w-5xl w-full px-4 md:px-8 relative z-10">
                <h2 class="text-[10px] font-mono text-gray-500 mb-12 tracking-[0.5em] border-b border-white/10 pb-4 uppercase solar-text" data-value="Nosso Atelier">Nosso Atelier</h2>
                <div class="space-y-0" role="list">
                    <div tabindex="0" role="listitem" aria-expanded="false" class="service-item border-b border-white/10 py-10 cursor-pointer group hover:pl-4 transition-all duration-500 hover-trigger" onclick="toggleService(this)" onkeydown="if(event.key==='Enter') this.click()">
                        <div class="flex justify-between items-baseline">
                            <h3 class="text-4xl md:text-6xl font-display italic text-gray-400 group-hover:text-white transition-colors solar-text" data-value="Materiais Premium">Materiais Premium</h3>
                            <span class="font-mono text-xs text-[var(--accent)] opacity-60 group-hover:opacity-100 solar-text transition-colors duration-1000" data-value="01">01</span>
                        </div>
                        <div class="service-desc max-h-0 overflow-hidden transition-all duration-500 ease-in-out opacity-0">
                            <p class="pt-6 max-w-xl text-gray-400 font-light text-sm leading-relaxed solar-text" data-value="Tecidos selecionados meticulosamente. Das fibras de algodão orgânico à seda mais pura, garantimos um toque inconfundível e conforto absoluto.">
                                Tecidos selecionados meticulosamente. Das fibras de algodão orgânico à seda mais pura, garantimos um toque inconfundível e conforto absoluto.
                            </p>
                        </div>
                    </div>
                    <div tabindex="0" role="listitem" aria-expanded="false" class="service-item border-b border-white/10 py-10 cursor-pointer group hover:pl-4 transition-all duration-500 hover-trigger" onclick="toggleService(this)" onkeydown="if(event.key==='Enter') this.click()">
                        <div class="flex justify-between items-baseline">
                            <h3 class="text-4xl md:text-6xl font-display italic text-gray-400 group-hover:text-white transition-colors solar-text" data-value="Design Autoral">Design Autoral</h3>
                            <span class="font-mono text-xs text-[var(--accent)] opacity-60 group-hover:opacity-100 solar-text transition-colors duration-1000" data-value="02">02</span>
                        </div>
                        <div class="service-desc max-h-0 overflow-hidden transition-all duration-500 ease-in-out opacity-0">
                            <p class="pt-6 max-w-xl text-gray-400 font-light text-sm leading-relaxed solar-text" data-value="Cada peça carrega o DNA SONIEN'S. Estampas criadas à mão e paletas neutras que oferecem versatilidade sem abrir mão do statement visual.">
                                Cada peça carrega o DNA SONIEN'S. Estampas criadas à mão e paletas neutras que oferecem versatilidade sem abrir mão do statement visual.
                            </p>
                        </div>
                    </div>
                    <div tabindex="0" role="listitem" aria-expanded="false" class="service-item border-b border-white/10 py-10 cursor-pointer group hover:pl-4 transition-all duration-500 hover-trigger" onclick="toggleService(this)" onkeydown="if(event.key==='Enter') this.click()">
                        <div class="flex justify-between items-baseline">
                            <h3 class="text-4xl md:text-6xl font-display italic text-gray-400 group-hover:text-white transition-colors solar-text" data-value="Corte Preciso">Corte Preciso</h3>
                            <span class="font-mono text-xs text-[var(--accent)] opacity-60 group-hover:opacity-100 solar-text transition-colors duration-1000" data-value="03">03</span>
                        </div>
                        <div class="service-desc max-h-0 overflow-hidden transition-all duration-500 ease-in-out opacity-0">
                            <p class="pt-6 max-w-xl text-gray-400 font-light text-sm leading-relaxed solar-text" data-value="A alfaiataria levada ao extremo do perfeccionismo. Caimentos impecáveis estudados exaustivamente para esculpir e valorizar a silhueta.">
                                A alfaiataria levada ao extremo do perfeccionismo. Caimentos impecáveis estudados exaustivamente para esculpir e valorizar a silhueta.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section-3d" data-z="3000" id="contact" aria-label="Área de Contacto">
            <div class="text-center px-4">
                <p class="font-mono text-gray-500 mb-8 text-xs tracking-widest solar-text uppercase" data-value="EXPERIMENTE O EXCLUSIVO">EXPERIMENTE O EXCLUSIVO</p>
                <h2 tabindex="0" role="button" aria-label="Abrir formulário para agendar prova" class="text-5xl md:text-9xl font-display italic mb-12 hover-trigger text-white mix-blend-difference cursor-pointer open-contact-btn magnetic-btn inline-block solar-text outline-none focus-visible:scale-105 transition-transform" data-value="Agende &#10; Uma Prova" onkeydown="if(event.key==='Enter') this.click()">
                    Agende <br> Uma Prova
                </h2>
                <div class="mt-4 flex justify-center">
                    <button tabindex="0" aria-label="Abrir Formulário de Atendimento" class="border border-[var(--accent)]/50 text-[var(--accent)] px-10 py-4 rounded-full text-xs font-mono tracking-widest hover:bg-[var(--accent)] hover:text-[var(--bg-color)] transition-colors duration-500 hover-trigger open-contact-btn magnetic-btn uppercase solar-text" data-value="Contactar Atelier">
                        Contactar Atelier
                    </button>
                </div>
            </div>
        </section>

        <section class="section-3d" data-z="4000" id="footer-section" aria-label="Rodapé do Site">
            <div class="flex flex-col items-center justify-center text-center gap-12 w-full px-6">
                <div class="text-6xl brand-logo-text tracking-tighter footer-shine-text" aria-hidden="true">SONIEN'S</div>
                <div class="flex gap-8 md:gap-12 items-center justify-center font-mono text-xs text-gray-400 uppercase flex-wrap">
                    <a tabindex="0" href="#" aria-label="Visitar o nosso Instagram" class="flex flex-col items-center gap-4 hover:text-[var(--accent)] transition-colors hover-trigger magnetic-btn group">
                        <i data-lucide="instagram" class="w-5 h-5 opacity-70 group-hover:opacity-100 transition-opacity" aria-hidden="true"></i>
                        <span class="solar-text" data-value="Instagram">Instagram</span>
                    </a>
                    <a tabindex="0" href="https://wa.me/5532988212111" target="_blank" aria-label="Contactar via WhatsApp" class="flex flex-col items-center gap-4 hover:text-[var(--accent)] transition-colors hover-trigger magnetic-btn group">
                        <svg class="w-5 h-5 opacity-70 group-hover:opacity-100 transition-opacity" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.888-.788-1.489-1.761-1.663-2.06-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.8 12.8 0 0 0-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>
                        <span class="solar-text" data-value="WhatsApp">WhatsApp</span>
                    </a>
                    <a tabindex="0" href="#" aria-label="Ver localização da Boutique" class="flex flex-col items-center gap-4 hover:text-[var(--accent)] transition-colors hover-trigger magnetic-btn group">
                        <i data-lucide="map-pin" class="w-5 h-5 opacity-70 group-hover:opacity-100 transition-opacity" aria-hidden="true"></i>
                        <span class="solar-text" data-value="Boutique">Boutique</span>
                    </a>
                </div>
                <div class="flex flex-col gap-2 font-mono text-[10px] text-gray-500 uppercase tracking-widest mt-12">
                    <p class="solar-text" data-value="Paris • Milão • São Paulo">Paris • Milão • São Paulo</p>
                    <p class="solar-text" data-value="© 2026 Sonien's Premium Apparel. Direitos Reservados.">© 2026 Sonien's Premium Apparel. Direitos Reservados.</p>
                </div>
            </div>
        </section>
    </div>

    <div id="dedicated-page" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Detalhes da Coleção Selecionada" class="fixed inset-0 bg-[var(--bg-color)] overflow-y-auto hidden opacity-0 transition-opacity duration-700 pointer-events-none" style="z-index: 10000;">
        <div class="noise-overlay"></div>
        
        <!-- NOVO: Eclipse Background (Luar fica na camada z-0, atrás das imagens/vídeos) -->
        <div id="eclipse-bg" class="fixed inset-0 pointer-events-none z-0 hidden opacity-0 transition-opacity duration-1000">
            <!-- OTIMIZADO: Removido o mix-blend-screen pesado. Usamos apenas transparência pura (/60 e /20) -->
            <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#9b111e]/60 via-[#9b111e]/20 to-transparent"></div>
        </div>
        
        <div class="sticky top-0 w-full p-6 md:p-10 flex justify-between items-center z-50 bg-[#0d0c0b]/90 backdrop-blur-md border-b border-white/5">
            <button tabindex="0" id="btn-back-page" aria-label="Voltar às Coleções" class="text-[var(--primary)] hover-trigger magnetic-btn flex items-center gap-3 font-mono text-[10px] uppercase tracking-widest hover:text-[var(--accent)] transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5" aria-hidden="true"></i> Voltar às Coleções
            </button>
            <div class="brand-logo-text text-xl tracking-widest text-[var(--accent)]" aria-hidden="true">SONIEN'S</div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-12 md:py-20 flex flex-col gap-16 md:gap-24 relative z-10">
            
            <div class="flex flex-col items-center text-center">
                <span id="page-tag" class="text-[10px] font-mono text-[var(--accent)] border border-[var(--accent)]/30 px-3 py-1 uppercase tracking-widest mb-6 inline-block solar-text transition-colors duration-1000" aria-live="polite"></span>
                <h2 id="page-title" class="text-5xl md:text-8xl font-display italic text-[var(--primary)] mb-8 solar-text transition-colors duration-1000" aria-live="polite"></h2>
            </div>
            
            <!-- OTIMIZADO: Contentor mantido com overflow-hidden para cortar os excessos -->
            <div class="w-full h-[50vh] md:h-[70vh] overflow-hidden border border-white/10 relative group bg-[#0d0c0b]" style="transform: translateZ(0);">
                
                <img id="page-image" src="" class="absolute inset-0 w-full h-full object-cover grayscale-[40%] group-hover:grayscale-0 transition-all duration-700 group-hover:scale-105" alt="Fotografia de arte da coleção">
                
                <video id="page-video" src="" autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover hidden pointer-events-none"></video>
                
                <!-- 
                     A MAGIA ACONTECE AQUI: 
                     1. left-1/2 top-1/2 e -translate centram o vídeo exatamente no meio.
                     2. O style usa matemática (max) para garantir que o iframe seja sempre 16:9 (177.77vh e 56.25vw) e maior que a tela.
                -->
                <iframe id="page-iframe" src="" frameborder="0" allow="autoplay; fullscreen" 
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden pointer-events-none transition-opacity duration-1000" 
                        style="width: max(100vw, 177.77vh); height: max(56.25vw, 100vh); max-width: none;">
                </iframe>
                
            </div>

            <div class="flex flex-col items-center">
                <p id="page-desc" class="text-gray-400 font-light leading-relaxed text-sm md:text-lg whitespace-pre-line text-left md:text-center max-w-3xl mx-auto solar-text" aria-live="polite"></p>
            </div>

            <div id="page-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
            </div>

            <div id="btn-container-reveal" class="flex flex-col items-center justify-center mt-8 mb-12 gap-4 w-full">
                <span class="text-[9px] font-mono tracking-widest text-gray-500 uppercase">Disponível para Encomenda</span>
                <button tabindex="0" id="show-form-btn" aria-label="Abrir formulário de personalização" class="border border-[var(--accent)]/50 text-[var(--accent)] px-10 py-5 md:px-16 md:py-6 rounded-full text-xl md:text-3xl font-display italic hover:bg-[var(--accent)] hover:text-[var(--bg-color)] transition-all duration-500 hover-trigger cursor-pointer magnetic-btn inline-block solar-text outline-none focus-visible:scale-105" data-value=""></button>
            </div>
            
            <div id="project-form-container" class="bg-white/5 p-8 md:p-12 border border-white/10 relative overflow-hidden flex-col justify-center hidden opacity-0 transition-all duration-700 w-full max-w-3xl mx-auto">
                <button id="close-form-btn" aria-label="Fechar Formulário" class="absolute top-6 right-6 text-[var(--primary)] hover:rotate-90 transition-transform hover-trigger z-50 magnetic-btn">
                    <i data-lucide="x" class="w-6 h-6" aria-hidden="true"></i>
                </button>
                
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[var(--accent)] to-transparent opacity-50 transition-colors duration-1000"></div>
                
                <h3 class="text-3xl md:text-4xl font-display italic text-[var(--primary)] mb-2 transition-colors duration-1000">Personalizar Peça</h3>
                <p class="text-gray-500 font-mono text-[10px] mb-10 uppercase tracking-widest">Camisetas Estampadas Premium</p>
                
                <div class="space-y-6 w-full relative z-20">
                    <div>
                        <label for="dp-name" class="text-[10px] font-mono text-gray-400 uppercase tracking-widest mb-2 block">Seu Nome / Contato</label>
                        <input id="dp-name" tabindex="0" type="text" class="form-input hover-trigger" placeholder="Nome Completo">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label for="dp-size" class="text-[10px] font-mono text-gray-400 uppercase tracking-widest mb-2 block">Tamanho</label>
                            <select id="dp-size" tabindex="0" class="form-input hover-trigger bg-transparent appearance-none cursor-pointer text-[var(--primary)]">
                                <option value="" disabled selected class="bg-[var(--bg-color)] text-gray-500">Escolha...</option>
                                <option value="P" class="bg-[var(--bg-color)]">P</option>
                                <option value="M" class="bg-[var(--bg-color)]">M</option>
                                <option value="G" class="bg-[var(--bg-color)]">G</option>
                                <option value="GG" class="bg-[var(--bg-color)]">GG</option>
                                <option value="XG" class="bg-[var(--bg-color)]">XG</option>
                            </select>
                        </div>
                        <div>
                            <label for="dp-color" class="text-[10px] font-mono text-gray-400 uppercase tracking-widest mb-2 block">Cor Base</label>
                            <select id="dp-color" tabindex="0" class="form-input hover-trigger bg-transparent appearance-none cursor-pointer text-[var(--primary)]">
                                <option value="" disabled selected class="bg-[var(--bg-color)] text-gray-500">Escolha...</option>
                                <option value="Preto" class="bg-[var(--bg-color)]">Preto Absoluto</option>
                                <option value="Branco" class="bg-[var(--bg-color)]">Branco Puro</option>
                                <option value="Off-White" class="bg-[var(--bg-color)]">Off-White (Creme)</option>
                                <option value="Cinza Mescla" class="bg-[var(--bg-color)]">Cinza Mescla</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="dp-msg" class="text-[10px] font-mono text-gray-400 uppercase tracking-widest mb-2 block">Ideia da Estampa</label>
                        <textarea id="dp-msg" tabindex="0" class="form-input hover-trigger resize-none" rows="3" placeholder="Qual personagem, cena ou citação deseja? Detalhe a sua ideia..."></textarea>
                    </div>
                    
                    <button id="dp-submit" tabindex="0" class="w-full bg-[var(--accent)] text-[var(--bg-color)] font-mono font-bold text-xs py-5 hover:bg-[var(--primary)] transition-colors tracking-widest mt-8 hover-trigger magnetic-btn uppercase">
                        Solicitar Criação
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ECLIPSE FX OVERLAY (Fumaça e Faíscas ficam na camada z-[10005], por cima do vídeo) -->
        <div id="eclipse-fg" class="fixed inset-0 pointer-events-none z-[10005] hidden opacity-0 transition-opacity duration-1000">
            <!-- Fumaça OTIMIZADA sem mix-blend-screen -->
            <div class="absolute inset-0 opacity-20 animate-smoke pointer-events-none"></div>
            <!-- Container de Faíscas -->
            <div id="sparks-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
        </div>

        <div class="h-20 w-full relative z-10"></div>
    </div>

    <div id="contact-modal" aria-hidden="true" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="contact-title">
        <div class="modal-content max-w-4xl bg-[var(--bg-color)] border border-white/10 p-0 flex flex-row overflow-hidden relative transition-colors duration-1000"> 
            <button id="close-contact" tabindex="0" aria-label="Fechar Contacto" class="absolute top-6 right-6 text-[var(--primary)] hover:rotate-90 transition-transform hover-trigger z-50 magnetic-btn">
                <i data-lucide="x" class="w-6 h-6" aria-hidden="true"></i>
            </button>
            <div class="hidden md:flex w-24 bg-[var(--accent)]/5 border-r border-white/5 flex-col justify-center items-center py-10 relative overflow-hidden transition-colors duration-1000">
                 <h2 id="contact-title" class="brand-logo-text text-4xl tracking-widest text-[var(--accent)]/20 whitespace-nowrap absolute transition-colors duration-1000" style="writing-mode: vertical-rl; transform: rotate(180deg);">SONIEN'S</h2>
            </div>
            <div class="flex-1 p-8 md:p-12 flex flex-col justify-center">
                <h3 class="text-3xl font-display italic text-[var(--primary)] mb-2 transition-colors duration-1000">Atendimento VIP</h3>
                <p class="text-gray-500 font-mono text-xs mb-10 uppercase">Permita-nos conhecer as suas preferências.</p>
                <div class="space-y-8 w-full">
                    <div>
                        <label for="form-name" class="sr-only">Nome Completo</label>
                        <input id="form-name" tabindex="0" type="text" class="form-input hover-trigger" placeholder="NOME COMPLETO">
                    </div>
                    <div>
                        <label for="form-email" class="sr-only">E-mail de Contacto</label>
                        <input id="form-email" tabindex="0" type="email" class="form-input hover-trigger" placeholder="EMAIL DE CONTACTO">
                    </div>
                    <div>
                        <label for="form-msg" class="sr-only">Peça de interesse ou detalhes</label>
                        <textarea id="form-msg" tabindex="0" class="form-input hover-trigger" rows="1" placeholder="QUAL PEÇA DESEJA EXPERIMENTAR?"></textarea>
                    </div>
                    <button id="submit-whatsapp" tabindex="0" aria-label="Enviar Mensagem de Agendamento" class="w-full bg-[var(--accent)] text-[var(--bg-color)] font-mono font-bold text-xs py-4 hover:bg-[var(--primary)] transition-colors tracking-widest mt-4 hover-trigger magnetic-btn uppercase">
                        Solicitar Agendamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let introCompleted = false;
        let isDedicatedPageOpen = false; 
        let scrollZ = 0;
        let targetScrollZ = 0;
        const sectionDistance = 1000;
        const maxScrollZ = 4000;
        let particlesGeometryGlobal; 
        let randomArrayGlobal; 
        let lastScrollTime = 0;
        const scrollCooldown = 1300; 

        const themes = {
            default: {
                primary: '#f5eedc', 
                accent: '#d4af37',  
                bg: '#0d0c0b',      
                particle1: 0xf5eedc,
                particle2: 0xd4af37
            },
            berserk: {
                primary: '#e5e5e5', 
                accent: '#9b111e',  
                bg: '#050303',      
                particle1: 0x9b111e, 
                particle2: 0x333333  
            }
        };

        function applyTheme(themeName) {
            const theme = themes[themeName] || themes.default;
            
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--accent', theme.accent);
            document.documentElement.style.setProperty('--bg-color', theme.bg);

            if (particlesGeometryGlobal && randomArrayGlobal) {
                const colorArray = particlesGeometryGlobal.attributes.color.array;
                const c1 = new THREE.Color(theme.particle1);
                const c2 = new THREE.Color(theme.particle2);
                
                for(let i=0; i< (colorArray.length / 3); i++) {
                    const i3 = i * 3;
                    const mixed = c1.clone().lerp(c2, randomArrayGlobal[i] * 0.5);
                    colorArray[i3] = mixed.r;
                    colorArray[i3+1] = mixed.g;
                    colorArray[i3+2] = mixed.b;
                }
                particlesGeometryGlobal.attributes.color.needsUpdate = true;
            }
        }
        
        // EFEITOS ESPECIAIS (FAÍSCAS E LUAR SEPARADOS)
        const EclipseFX = {
            interval: null,
            start: function() {
                const bg = document.getElementById('eclipse-bg');
                const fg = document.getElementById('eclipse-fg');
                const sparks = document.getElementById('sparks-container');
                if(!bg || !fg || !sparks) return;
                
                bg.classList.remove('hidden');
                fg.classList.remove('hidden');
                void bg.offsetWidth;
                void fg.offsetWidth;
                bg.style.opacity = '1';
                fg.style.opacity = '1';

                this.interval = setInterval(() => {
                    if (document.hidden) return; 
                    const spark = document.createElement('div');
                    spark.className = 'absolute bottom-[-10px] rounded-full mix-blend-screen pointer-events-none';
                    const colors = ['bg-[#ffaa00]', 'bg-[#ff4400]', 'bg-[#9b111e]'];
                    spark.classList.add(colors[Math.floor(Math.random() * colors.length)]);
                    
                    const size = Math.random() * 4 + 2; 
                    spark.style.width = size + 'px';
                    spark.style.height = (size * 1.5) + 'px';
                    spark.style.filter = `blur(${Math.random()}px)`;
                    spark.style.boxShadow = `0 0 ${size * 2}px ${spark.className.includes('ffaa00') ? '#ffaa00' : '#ff4400'}`;
                    
                    const startX = Math.random() * window.innerWidth;
                    spark.style.left = startX + 'px';
                    
                    sparks.appendChild(spark);
                    
                    const duration = Math.random() * 3000 + 2000; 
                    const endX = startX + (Math.random() - 0.5) * 300; 
                    const endY = - (Math.random() * window.innerHeight * 0.8 + 200);
                    
                    const animation = spark.animate([
                        { transform: 'translate3d(0, 0, 0) scale(1)', opacity: Math.random() * 0.5 + 0.5 },
                        { transform: `translate3d(${endX - startX}px, ${endY}px, 0) scale(0.2)`, opacity: 0 }
                    ], {
                        duration: duration,
                        easing: 'cubic-bezier(0.25, 1, 0.5, 1)', 
                        fill: 'forwards'
                    });
                    
                    animation.onfinish = () => spark.remove();
                }, 150); 
            },
            stop: function() {
                const bg = document.getElementById('eclipse-bg');
                const fg = document.getElementById('eclipse-fg');
                if(!bg || !fg) return;
                
                bg.style.opacity = '0';
                fg.style.opacity = '0';
                clearInterval(this.interval);
                
                setTimeout(() => {
                    bg.classList.add('hidden');
                    fg.classList.add('hidden');
                    const sparks = document.getElementById('sparks-container');
                    if(sparks) sparks.innerHTML = '';
                }, 1000);
            }
        };

        const EMAILJS_PUBLIC_KEY = "mdn_-MJTIEla5ZNLS";
        const EMAILJS_SERVICE_ID = "service_qrkdi0q";
        const EMAILJS_TEMPLATE_ID = "template_k32a7va";
        
        const serviceImagesData = [
            ["https://images.unsplash.com/photo-1584100936595-c0654b55a2e2?q=80&w=1000&auto=format&fit=crop", "https://images.unsplash.com/photo-1528360983277-13d401cdc186?q=80&w=1000&auto=format&fit=crop"], 
            ["https://images.unsplash.com/photo-1558692518-fc0c9ce112d8?q=80&w=1000&auto=format&fit=crop", "https://images.unsplash.com/photo-1534440026214-38b46e3eaec9?q=80&w=1000&auto=format&fit=crop"], 
            ["https://images.unsplash.com/photo-1556905055-8f358a7a47b2?q=80&w=1000&auto=format&fit=crop", "https://images.unsplash.com/photo-1594938328870-982424b41300?q=80&w=1000&auto=format&fit=crop"]  
        ];

        const projects = [
            {
                title: "Sétima Arte",
                desc: "A magia da tela grande, agora esculpida em fios de algodão premium. A coleção Sétima Arte é um tributo visceral aos clássicos do cinema e às produções que moldaram gerações.\n\nMais do que meras estampas, capturamos a alma de cenas icônicas, a profundidade de citações inesquecíveis e a estética inconfundível de pôsteres lendários. Cada peça é desenhada à mão, traduzindo o dramatismo do cinema para o minimalismo sofisticado da alta costura urbana. O corte estruturado da malha pesada evoca a presença de um fato bem talhado, enquanto os acabamentos desfiados a laser remetem à película gasta de 35mm.\n\nSUGESTÕES DE ATELIER:\n• Silhuetas noir de obras clássicas do suspense.\n• Citações tipográficas elegantes e minimalistas bordadas à gola.\n• Releituras geométricas de cenários inesquecíveis.",
                year: "CINE '26", tag: "FILMES & SÉRIES",
                image: "https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?q=80&w=2670&auto=format&fit=crop",
                extraImages: [
                    "https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=1000&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1542204165-65bf26472b9b?q=80&w=1000&auto=format&fit=crop"
                ],
                ctaText: "Personificar\na Sétima Arte"
            },
            {
                title: "Cultura Otaku: Berserk",
                desc: "O Eclipse chegou ao nosso atelier. Esta coleção cápsula exclusiva mergulha nas trevas e na resiliência inabalável do universo de Kentaro Miura.\n\nCada peça é um tributo à jornada de Guts, utilizando malhas estonadas que simulam o desgaste de mil batalhas e estampas em serigrafia de alta densidade. O sangue, o aço e a Marca do Sacrifício ganham contornos de Alta Costura, transformando a brutalidade de Berserk numa declaração de estilo intemporal e sombria. A base têxtil utiliza malha de alta gramatura com caimento *oversized*, garantindo silhuetas amplas e arquitetónicas prontas para a batalha.\n\nSUGESTÕES DE ATELIER:\n• A Marca do Sacrifício bordada a fio vermelho no colarinho.\n• Painéis do Eclipse em tons de cinza chumbo nas costas.\n• A espada Dragonslayer estruturada em alto relevo ao longo da manga.",
                year: "DROP '26", tag: "CÁPSULA ESPECIAL",
                image: "https://images.unsplash.com/photo-1607604276583-eef5d076aa5f?q=80&w=2670&auto=format&fit=crop", 
                pageImage: "https://i.postimg.cc/bNJsDKdt/digital_art_eclipse_clouds_berserk_wallpaper_preview_Copia.jpg", 
                pageVideo: "https://player.vimeo.com/video/1169350461?background=1&autoplay=1&loop=1&muted=1",
                extraImages: [
                    "https://i.postimg.cc/yYdkgwWc/1405de4e5c788d83fe2eff9e4a7ef3a3_be80a14f7660996cb117017327600989_1024_1024.webp",
                    "https://i.postimg.cc/CL1zBWdD/3616cf8650e3b2a04381c9d03264f1cf_5811569d84ab3cfc1c17017327607027_1024_1024.webp"
                ],
                ctaText: "Sobreviver ao\nEclipse",
                themeTrigger: "berserk", 
                themeMusic: "https://anonymous-fuchsia-xkrni71i0g.edgeone.app/Berserk_soundtrack_-_4_Gatsu_(mp3.pm).mp3" 
            },
            {
                title: "Páginas Literárias",
                desc: "A literatura ganha textura, caimento e forma. A coleção Páginas Literárias foi concebida para quem encontra refúgio entre as palavras.\n\nTransformamos os trechos que mudaram a sua vida em arte tipográfica de alto nível. Cartografamos mapas de mundos fantásticos com detalhes meticulosos e reinterpretamos capas de livros clássicos através de uma ótica contemporânea e abstrata. Vista a sua história e leve consigo o peso poético dos maiores autores da humanidade. Os tons base transitam entre o Off-White envelhecido, como papiro, e o Preto Absoluto da tinta nanquim.\n\nSUGESTÕES DE ATELIER:\n• O mapa da sua fantasia épica favorita texturizado nas costas.\n• Frases marcantes bordadas na bainha interior.\n• Elementos-chave da narrativa em estilo line-art no peito.",
                year: "LORE '26", tag: "LIVROS & CONTOS",
                image: "https://images.unsplash.com/photo-1456615074700-1dc12aa7364d?q=80&w=2670&auto=format&fit=crop",
                extraImages: [
                    "https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=1000&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1589829085413-56de8ae18c73?q=80&w=1000&auto=format&fit=crop"
                ],
                ctaText: "Vestir a\nSua História"
            },
            {
                title: "Acordes & Versos",
                desc: "Vista a frequência da sua alma. A coleção Acordes & Versos foge do óbvio das tradicionais 'camisetas de banda'. Pegamos no ritmo que dita a sua vida e traduzimo-lo num design vanguardista.\n\nCapas de álbuns históricos são desconstruídas em formas e sombras. Ondas sonoras das suas faixas favoritas ganham vida matemática na estampa. Letras de músicas tornam-se manifestos visuais com a estética premium e limpa que define o nosso atelier. Cada peça sofre um processo de lavagem vintage manual que quebra a rigidez do algodão, deixando-a com o toque de uma peça de arquivo raríssima.\n\nSUGESTÕES DE ATELIER:\n• O espectro de áudio exato do refrão da sua música em relevo.\n• Capas de álbuns icónicos em design abstrato monocromático.\n• Contornos de instrumentos em traço único contínuo.",
                year: "AUDIO '26", tag: "MÚSICA & BANDAS",
                image: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=2670&auto=format&fit=crop",
                extraImages: [
                    "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1000&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1459749411175-04bf5292ceea?q=80&w=1000&auto=format&fit=crop"
                ],
                ctaText: "Materializar\no Som"
            },
            {
                title: "Raízes & Elementos",
                desc: "Uma ode à imensidão do cosmos e à perfeição da terra. A coleção Raízes & Elementos é onde a ciência encontra a arte visual.\n\nDetalhamos constelações precisas, ciclos lunares e anatomia celeste com rigor científico e beleza imponente. Em contrapartida, exploramos a força do mundo natural com ilustrações de flora exótica, paisagens em pontilhismo e a dualidade fascinante da vida selvagem. Uma ligação profunda entre o micro e o macrocosmos. Pigmentos naturais e acabamentos sustentáveis completam o elo perfeito com a matéria prima.\n\nSUGESTÕES DE ATELIER:\n• O mapa astral exato do dia e local do seu nascimento.\n• Ilustrações botânicas vintage detalhadas a traço fino.\n• Animais de poder formados por geometria sagrada.",
                year: "EARTH '26", tag: "NATUREZA & ASTRONOMIA",
                image: "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2674&auto=format&fit=crop",
                extraImages: [
                    "https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1000&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1454789548928-9efd52dc4031?q=80&w=1000&auto=format&fit=crop"
                ],
                ctaText: "Ligar-se aos\nElementos"
            },
            {
                title: "Sua Arte Aqui",
                desc: "A colaboração máxima entre o cliente e o criador. Na linha Bespoke (Sob Medida), a tela em branco aguarda a sua visão e a sua imaginação dita os limites.\n\nUma homenagem ao seu animal de estimação? Uma referência a um jogo que adora? Um meme transformado em arte sacra minimalista? O nosso atelier ouvirá a sua história e desenhará, a partir do zero, uma estampa 100% autoral, exclusiva e impossível de encontrar em outro lugar do mundo.\n\nO PROCESSO BESPOKE:\n1. Você descreve a sua visão e referências detalhadamente.\n2. O atelier estuda o conceito e cria opções exclusivas de design, alinhadas à nossa estética de alta costura.\n3. A sua peça única ganha vida com qualidade impecável e chega às suas mãos numa embalagem selada.",
                year: "BESPOKE '26", tag: "PERSONALIZÁVEL",
                image: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=2671&auto=format&fit=crop",
                extraImages: [
                    "https://images.unsplash.com/photo-1558692518-fc0c9ce112d8?q=80&w=1000&auto=format&fit=crop",
                    "https://images.unsplash.com/photo-1544816155-12df9643f363?q=80&w=1000&auto=format&fit=crop"
                ],
                ctaText: "Iniciar a\nSua Obra"
            }
        ];

        let lastTypingTime = 0; 
        
        const SoundManager = {
            ctx: null, masterGain: null, ambientNodes: [],
            themeAudioObj: null, 
            
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 1.5; 
                    this.masterGain.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            playThemeMusic: function(url) {
                this.stopThemeMusic(); 
                
                try {
                    this.themeAudioObj = new Audio(url);
                    this.themeAudioObj.loop = true;
                    this.themeAudioObj.volume = 0; 
                    
                    this.themeAudioObj.play().then(() => {
                        let vol = 0;
                        const fadeInterval = setInterval(() => {
                            vol += 0.02;
                            if (vol >= 0.4) {
                                clearInterval(fadeInterval);
                                if(this.themeAudioObj) this.themeAudioObj.volume = 0.4;
                            } else {
                                if(this.themeAudioObj) this.themeAudioObj.volume = vol;
                            }
                        }, 100);
                    }).catch(e => {
                        console.warn("Navegador bloqueou ou não encontrou o áudio:", e);
                    });
                } catch (err) {
                    console.warn("Erro ao tentar tocar a Música Tema:", err);
                }
            },

            stopThemeMusic: function() {
                if (this.themeAudioObj) {
                    let vol = this.themeAudioObj.volume;
                    const audioToStop = this.themeAudioObj; 
                    this.themeAudioObj = null; 
                    
                    const fadeInterval = setInterval(() => {
                        vol -= 0.05;
                        if (vol <= 0) {
                            clearInterval(fadeInterval);
                            audioToStop.pause();
                            audioToStop.currentTime = 0;
                        } else {
                            audioToStop.volume = vol;
                        }
                    }, 100);
                }
            },

            playAmbient: function() {
                if (!this.ctx) return;
                try {
                    this.stopAmbient();
                    const osc1 = this.ctx.createOscillator();
                    osc1.type = 'sine'; osc1.frequency.value = 40; 
                    const gain1 = this.ctx.createGain(); gain1.gain.value = 0.3; 
                    osc1.connect(gain1).connect(this.masterGain); osc1.start();
                    
                    const osc2 = this.ctx.createOscillator();
                    osc2.type = 'sine'; osc2.frequency.value = 40.5; 
                    const gain2 = this.ctx.createGain(); gain2.gain.value = 0.2; 
                    osc2.connect(gain2).connect(this.masterGain); osc2.start();

                    const bufferSize = this.ctx.sampleRate * 2;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        data[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = data[i];
                        data[i] *= 2.0; 
                    }
                    const noise = this.ctx.createBufferSource(); noise.buffer = buffer; noise.loop = true;
                    const noiseFilter = this.ctx.createBiquadFilter(); noiseFilter.type = 'lowpass'; noiseFilter.frequency.value = 150; 
                    const noiseGain = this.ctx.createGain(); noiseGain.gain.value = 0.1; 
                    noise.connect(noiseFilter).connect(noiseGain).connect(this.masterGain); noise.start();
                    this.ambientNodes.push(osc1, osc2, gain1, gain2, noise, noiseFilter, noiseGain);
                } catch(e) {}
            },

            stopAmbient: function() {
                this.ambientNodes.forEach(node => { try { if(node.stop) node.stop(); node.disconnect(); } catch(e){} });
                this.ambientNodes = [];
            },

            playTyping: function() {
                if (!this.ctx) return;
                const now = Date.now();
                if (now - lastTypingTime < 40) return; 
                lastTypingTime = now;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(3000 + Math.random() * 500, t); osc.type = 'triangle'; 
                gain.gain.setValueAtTime(0.02, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.02); 
                osc.connect(gain).connect(this.masterGain); osc.start(t); osc.stop(t + 0.03);
            },

            playHover: function() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const bufferSize = this.ctx.sampleRate * 0.1;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter(); filter.type = 'bandpass'; filter.Q.value = 1.0;
                filter.frequency.setValueAtTime(2000, t);
                filter.frequency.exponentialRampToValueAtTime(4000, t + 0.1);
                
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                
                noise.connect(filter).connect(gain).connect(this.masterGain);
                noise.start(t);
            },

            playClick: function() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                
                const osc1 = this.ctx.createOscillator(); osc1.type = 'sine'; osc1.frequency.setValueAtTime(800, t);
                const osc2 = this.ctx.createOscillator(); osc2.type = 'sine'; osc2.frequency.setValueAtTime(1200, t);
                
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.15, t);
                gain.gain.setTargetAtTime(0.05, t + 0.05, 0.1); 
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.6); 
                
                osc1.connect(gain); osc2.connect(gain); gain.connect(this.masterGain);
                osc1.start(t); osc2.start(t); osc1.stop(t+0.7); osc2.stop(t+0.7);
            },

            playWarp: function() {
                if(!this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.8;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource(); noise.buffer = buffer;
                
                const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.Q.value = 0.5;
                filter.frequency.setValueAtTime(100, this.ctx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.4); 
                filter.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.8); 
                
                const gain = this.ctx.createGain(); gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.15, this.ctx.currentTime + 0.4);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.8);
                
                noise.connect(filter).connect(gain).connect(this.masterGain); noise.start();
            },

            playSupernova: function() {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                const masterSupernovaGain = this.ctx.createGain();
                
                masterSupernovaGain.gain.setValueAtTime(0, t);
                masterSupernovaGain.gain.linearRampToValueAtTime(0.3, t + 1.0);
                masterSupernovaGain.gain.exponentialRampToValueAtTime(0.001, t + 4.0);
                masterSupernovaGain.connect(this.masterGain);

                const freqs = [65.41, 164.81, 196.00, 246.94, 293.66];
                freqs.forEach(f => {
                    const osc = this.ctx.createOscillator(); osc.type = 'sine';
                    osc.frequency.setValueAtTime(f, t);
                    osc.connect(masterSupernovaGain);
                    osc.start(t); osc.stop(t + 4.5);
                });
            },

            playTick: function() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator(); osc.type = 'triangle';
                const gain = this.ctx.createGain();
                
                osc.frequency.setValueAtTime(600, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.02);
                
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.02);
                
                osc.connect(gain).connect(this.masterGain);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.03);
            }
        };

        let liquidAnimReq;
        function pulseLiquid() {
            const map = document.getElementById('liquid-map');
            if(!map) return;
            let scale = 40; 
            cancelAnimationFrame(liquidAnimReq); 
            
            function animateLiquid() {
                scale *= 0.88;
                map.setAttribute('scale', scale);
                if (scale >= 0.5) {
                    liquidAnimReq = requestAnimationFrame(animateLiquid);
                } else {
                    map.setAttribute('scale', 0);
                }
            }
            animateLiquid();
        }

        const glyphs = "█▓▒░<>/"; 
        function solarReveal(element) {
            const originalText = element.dataset.value || element.innerText;
            if(!element.dataset.value) element.dataset.value = originalText;
            
            element.classList.add('solar-active');
            element.innerText = '';
            
            const chars = originalText.split('');
            const spans = chars.map(char => {
                const span = document.createElement('span');
                if(char === ' ' || char === '\n') {
                    span.innerHTML = char === '\n' ? '<br>' : ' ';
                    element.appendChild(span);
                    return null;
                }
                span.innerText = glyphs[Math.floor(Math.random() * glyphs.length)];
                span.className = 'solar-dim';
                element.appendChild(span);
                return span;
            });

            let startTimestamp;
            function step(timestamp) {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = timestamp - startTimestamp;
                const frame = progress / 40; 
                
                if (Math.random() > 0.8) SoundManager.playTyping();
                
                spans.forEach((span, i) => {
                    if(!span) return;
                    const revealPoint = (i / spans.length) * 20;
                    if(frame > revealPoint) {
                        if(frame < revealPoint + 5) {
                            span.innerText = glyphs[Math.floor(Math.random() * glyphs.length)];
                            span.className = 'solar-spark';
                        } else {
                            span.innerText = chars[i];
                            span.className = '';
                            span.style.opacity = 1;
                            span.style.color = '';
                        }
                    }
                });

                if (frame <= 50) {
                    requestAnimationFrame(step);
                } else {
                    element.innerHTML = originalText.replace(/\n/g, '<br>');
                }
            }
            requestAnimationFrame(step);
        }

        function initThreeJS() {
            const canvas = document.getElementById('webgl-canvas');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0d0c0b, 0.0015); 

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 6000); 
            
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            const particlesCount = 2000;
            const geometry = new THREE.BufferGeometry();
            const posArray = new Float32Array(particlesCount * 3);
            const originalPosArray = new Float32Array(particlesCount * 3);
            
            randomArrayGlobal = new Float32Array(particlesCount);
            const colorArray = new Float32Array(particlesCount * 3);
            
            const color1 = new THREE.Color(themes.default.particle1);
            const color2 = new THREE.Color(themes.default.particle2);

            const tunnelLength = 6000; 

            for(let i=0; i<particlesCount; i++) {
                const i3 = i * 3;
                const x = (Math.random() - 0.5) * 600; 
                const y = (Math.random() - 0.5) * 600;
                const z = (Math.random() - 0.5) * tunnelLength;
                
                posArray[i3] = x; posArray[i3+1] = y; posArray[i3+2] = z;
                originalPosArray[i3] = x; originalPosArray[i3+1] = y; originalPosArray[i3+2] = z;
                randomArrayGlobal[i] = Math.random();

                const mixedColor = color1.clone().lerp(color2, randomArrayGlobal[i] * 0.5);
                colorArray[i3] = mixedColor.r; colorArray[i3+1] = mixedColor.g; colorArray[i3+2] = mixedColor.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));
            particlesGeometryGlobal = geometry; 

            const material = new THREE.PointsMaterial({
                size: 0.9, vertexColors: true, transparent: true, opacity: 0.7, blending: THREE.AdditiveBlending
            });

            particlesMeshGlobal = new THREE.Points(geometry, material);
            scene.add(particlesMeshGlobal);

            let mouseX = 0, mouseY = 0;
            let targetRotationX = 0, targetRotationY = 0;

            document.addEventListener('mousemove', e => {
                mouseX = (e.clientX - window.innerWidth/2);
                mouseY = (e.clientY - window.innerHeight/2);
            }, { passive: true });

            const clock = new THREE.Clock();

            function animate() {
                // CORREÇÃO: Atualiza o cursor sempre, independentemente de o fundo 3D estar pausado!
                updateDualCursor();

                // OTIMIZAÇÃO EXTREMA: Se a página dedicada (vídeo) estiver aberta, congela o motor 3D!
                if (isDedicatedPageOpen) {
                    requestAnimationFrame(animate);
                    return; // Aborta todos os cálculos matemáticos e de renderização 3D
                }

                const time = clock.getElapsedTime();
                const positions = geometry.attributes.position.array;
                
                scrollZ += (targetScrollZ - scrollZ) * 0.035;
                camera.position.z = -scrollZ;
                
                camera.position.x += (mouseX * 0.05 - camera.position.x) * 0.05;
                camera.position.y += (-mouseY * 0.05 - camera.position.y) * 0.05;

                targetRotationY = (mouseX / window.innerWidth) * 0.2;
                targetRotationX = (mouseY / window.innerHeight) * 0.2;
                camera.rotation.y += (targetRotationY - camera.rotation.y) * 0.05;
                camera.rotation.x += (targetRotationX - camera.rotation.x) * 0.05;
                camera.rotation.z += (mouseX * 0.0001 - camera.rotation.z) * 0.05; 

                const winW = window.innerWidth || 1; 
                const winH = window.innerHeight || 1;
                const forceX = (mouseX / winW) * 70; 
                const forceY = -(mouseY / winH) * 70;
                const camZ = camera.position.z; 

                for(let i=0; i<particlesCount; i++) {
                    const i3 = i*3;
                    let z = positions[i3+2];
                    const relativeZ = z - camZ;
                    
                    if (relativeZ > 1000) {
                        positions[i3+2] -= tunnelLength; 
                    } else if (relativeZ < -(tunnelLength - 1000)) {
                        positions[i3+2] += tunnelLength;
                    }

                    const driftX = Math.sin(time * 0.8 + randomArrayGlobal[i] * 10) * 4;
                    const driftY = Math.cos(time * 0.6 + randomArrayGlobal[i] * 10) * 4;
                    const distFactor = 1 + (randomArrayGlobal[i] * 0.5);

                    let targetX = originalPosArray[i3] - (forceX * distFactor) + driftX;
                    let targetY = originalPosArray[i3+1] - (forceY * distFactor) + driftY;

                    positions[i3] += (targetX - positions[i3]) * 0.1;
                    positions[i3+1] += (targetY - positions[i3+1]) * 0.1;
                }
                geometry.attributes.position.needsUpdate = true;
                
                particlesMeshGlobal.rotation.z = time * 0.01; 

                const activeZ = Math.round(scrollZ / 1000) * 1000;
                document.querySelectorAll('.dot-inner').forEach(dot => {
                    if (parseInt(dot.dataset.z) === activeZ) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });

                updateHTMLSections();
                updateCarousel3D();
                // (O updateDualCursor que estava aqui foi movido para o topo)

                document.getElementById('hud-coords').innerText = `COLEÇÃO: ESSÊNCIA | PROFUNDIDADE: ${Math.floor(scrollZ)} PX`;
                
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                initCarousel(); 
            });
        }

        let cursorX = window.innerWidth / 2, cursorY = window.innerHeight / 2;
        let trailX = cursorX, trailY = cursorY;
        let isHovering = false;

        function initDualCursor() {
            const dot = document.querySelector('.cursor-dot');
            const trail = document.querySelector('.cursor-trail');
            
            if(window.matchMedia("(pointer: fine)").matches) {
                document.addEventListener('mousemove', e => {
                    cursorX = e.clientX;
                    cursorY = e.clientY;
                }, { passive: true });
                
                document.addEventListener('mouseover', e => {
                    if(e.target.closest('.hover-trigger')) {
                        isHovering = true;
                        trail.style.width = "60px";
                        trail.style.height = "60px";
                        trail.style.backgroundColor = "rgba(212, 175, 55, 0.15)"; 
                        trail.style.borderColor = "transparent";
                        SoundManager.playHover();
                    } else {
                        isHovering = false;
                        trail.style.width = "var(--cursor-trail-size)";
                        trail.style.height = "var(--cursor-trail-size)";
                        trail.style.backgroundColor = "transparent";
                        trail.style.borderColor = "var(--accent)";
                    }
                }, { passive: true });
            }
        }

        function updateDualCursor() {
            if(!window.matchMedia("(pointer: fine)").matches) return;
            const dot = document.querySelector('.cursor-dot');
            const trail = document.querySelector('.cursor-trail');
            
            trailX += (cursorX - trailX) * 0.15;
            trailY += (cursorY - trailY) * 0.15;
            
            dot.style.transform = `translate3d(calc(${cursorX}px - 50%), calc(${cursorY}px - 50%), 0) scale(${isHovering ? 0 : 1})`;
            trail.style.transform = `translate3d(calc(${trailX}px - 50%), calc(${trailY}px - 50%), 0)`;
        }

        function initMagneticButtons() {
            const magneticElements = document.querySelectorAll('.magnetic-btn');
            
            magneticElements.forEach(elem => {
                elem.addEventListener('mousemove', (e) => {
                    const rect = elem.getBoundingClientRect();
                    const x = e.clientX - rect.left - rect.width / 2;
                    const y = e.clientY - rect.top - rect.height / 2;
                    
                    const strength = elem.classList.contains('text-5xl') ? 0.15 : 0.3;
                    
                    elem.style.transform = `translate(${x * strength}px, ${y * strength}px)`;
                    elem.style.transition = 'none'; 
                });
                
                elem.addEventListener('mouseleave', () => {
                    elem.style.transform = `translate(0px, 0px)`;
                    elem.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease';
                });
            });
        }

        function initCarousel() {
            const stage = document.getElementById('carousel-stage');
            stage.innerHTML = '';
            // OTIMIZADO: Raio de rotação reduzido no mobile para combinar com os cartões mais pequenos
            const radius = window.innerWidth < 768 ? 160 : 380;
            const angleStep = 360 / projects.length;

            projects.forEach((proj, i) => {
                const el = document.createElement('div');
                el.className = 'project-card-3d hover-trigger'; 
                el.tabIndex = 0; 
                el.setAttribute('role', 'button');
                el.setAttribute('aria-label', 'Ver detalhes da coleção ' + proj.title);
                el.style.transform = `rotateY(${i * angleStep}deg) translateZ(${radius}px)`;
                
                // OTIMIZADO: Descrição removida para poupar espaço. Apenas Imagem, Título, Ano e Tag.
                el.innerHTML = `
                    <div class="card-image-container">
                        <img src="${proj.image}" alt="${proj.title}">
                    </div>
                    <div class="flex flex-col flex-1 w-full justify-center">
                        <div class="flex justify-between items-center w-full">
                            <div class="flex-1 min-w-0 pr-2">
                                <span class="text-[8px] md:text-[9px] font-mono text-[var(--accent)] tracking-wider block mb-1 truncate transition-colors duration-1000">${proj.tag}</span>
                                <h3 class="text-lg md:text-2xl font-display italic text-white truncate solar-text card-solar-text transition-colors duration-1000" data-value="${proj.title}">${proj.title}</h3>
                            </div>
                            <span class="text-[8px] md:text-[9px] font-mono text-gray-500 flex-shrink-0">${proj.year}</span>
                        </div>
                    </div>
                `;
            
            el.addEventListener('mouseenter', () => {
                if(introCompleted && !isDraggingCarousel) pulseLiquid();
            }, { passive: true });
            
            const openProject = (e) => {
                if (!introCompleted) return;
                
                if (dragDistanceCarousel > 5) {
                    if(e.type === 'click') { e.preventDefault(); e.stopPropagation(); return; }
                }
                SoundManager.playClick();

                if (proj.themeTrigger) {
                    applyTheme(proj.themeTrigger);
                    if (proj.themeMusic) {
                        SoundManager.playThemeMusic(proj.themeMusic);
                    }
                    if (proj.themeTrigger === 'berserk') {
                        EclipseFX.start();
                    }
                }
                
                document.getElementById('page-title').innerText = proj.title;
                document.getElementById('page-title').dataset.value = proj.title;
                
                document.getElementById('page-desc').innerText = proj.desc;
                document.getElementById('page-desc').dataset.value = proj.desc;
                
                document.getElementById('page-tag').innerText = proj.tag;
                document.getElementById('page-tag').dataset.value = proj.tag;
                
                const pageImage = document.getElementById('page-image');
                const pageVideo = document.getElementById('page-video');
                const pageIframe = document.getElementById('page-iframe');
                
                if (proj.pageVideo) {
                    if (proj.pageVideo.includes('vimeo.com') || proj.pageVideo.includes('youtube.com')) {
                        pageIframe.src = proj.pageVideo;
                        pageIframe.classList.remove('hidden');
                        pageVideo.classList.add('hidden');
                        pageImage.classList.add('hidden');
                        pageVideo.pause();
                    } else {
                        pageVideo.src = proj.pageVideo;
                        pageVideo.classList.remove('hidden');
                        pageIframe.classList.add('hidden');
                        pageImage.classList.add('hidden');
                        pageIframe.src = "";
                        pageVideo.play().catch(e => console.warn("Autoplay bloqueado:", e));
                    }
                } else {
                    pageVideo.classList.add('hidden');
                    pageIframe.classList.add('hidden');
                    pageVideo.pause();
                    pageVideo.src = "";
                    pageIframe.src = "";
                    pageImage.classList.remove('hidden');
                    pageImage.src = proj.pageImage || proj.image;
                }

                const gallery = document.getElementById('page-gallery');
                gallery.innerHTML = '';
                if(proj.extraImages) {
                    proj.extraImages.forEach(imgUrl => {
                        gallery.innerHTML += `
                            <div class="w-full h-64 md:h-[450px] overflow-hidden border border-white/10 group relative z-10">
                                <img src="${imgUrl}" class="w-full h-full object-cover grayscale-[40%] group-hover:grayscale-0 transition-all duration-700 group-hover:scale-105" alt="Detalhe da coleção">
                            </div>
                        `;
                    });
                }

                const showFormBtn = document.getElementById('show-form-btn');
                const flatText = proj.ctaText.replace('\n', ' '); 
                showFormBtn.innerText = flatText;
                showFormBtn.dataset.value = flatText;
                showFormBtn.style.opacity = 1;
                showFormBtn.style.pointerEvents = 'auto';
                document.getElementById('btn-container-reveal').style.display = 'flex';
                
                const formContainer = document.getElementById('project-form-container');
                formContainer.classList.add('hidden');
                formContainer.classList.remove('flex');
                formContainer.style.opacity = 0;
                
                document.getElementById('dp-size').value = "";
                document.getElementById('dp-color').value = "";
                document.getElementById('dp-msg').value = "";
                
                isDedicatedPageOpen = true; 
                const page = document.getElementById('dedicated-page');
                page.style.display = 'block';
                page.setAttribute('aria-hidden', 'false');
                void page.offsetWidth;
                page.classList.remove('hidden');
                page.style.opacity = 1;
                page.style.pointerEvents = 'auto';
                
                page.scrollTop = 0;
                
                setTimeout(() => {
                    solarReveal(document.getElementById('page-title'));
                    solarReveal(document.getElementById('page-tag'));
                    solarReveal(document.getElementById('page-desc'));
                    solarReveal(document.getElementById('show-form-btn'));
                }, 300);
            };

            el.onclick = openProject;
            el.onkeydown = (e) => { if(e.key === 'Enter') openProject(e); };

            stage.appendChild(el);
        });
    }

    let carouselRot = 0;
    let targetCarouselRot = 0;
    let isDraggingCarousel = false;
    let startXCarousel = 0;
    let autoRotateCarousel = true;
    let autoRotateTimeout = null;
    let dragDistanceCarousel = 0;
    let lastTickRot = 0; 
    let carouselVelocity = 0; 

    function updateCarousel3D() {
        const stage = document.getElementById('carousel-stage');
        if(!stage) return;
        
        if (!isDraggingCarousel) {
            if (Math.abs(carouselVelocity) > 0.5) {
                targetCarouselRot -= carouselVelocity;
                carouselVelocity *= 0.94; 
            } else {
                carouselVelocity = 0;
                if (!autoRotateCarousel) {
                    const angleStep = 360 / projects.length;
                    let closestSnap = Math.round(targetCarouselRot / angleStep) * angleStep;
                    targetCarouselRot += (closestSnap - targetCarouselRot) * 0.05; 
                } else if (!stage.matches(':hover')) {
                    targetCarouselRot += 0.08; 
                }
            }
        }

        const delta = (targetCarouselRot - carouselRot) * 0.08;
        carouselRot += delta;
        stage.style.transform = `rotateY(${-carouselRot}deg)`;

        if (Math.abs(carouselRot - lastTickRot) > 15) {
            if (isDraggingCarousel || Math.abs(delta) > 0.5) {
                SoundManager.playTick();
            }
            lastTickRot = carouselRot;
        }

        const workSection = document.getElementById('work');
        if (workSection && workSection.classList.contains('active-section')) {
            const angleStep = 360 / projects.length;
            let normalizedRot = ((carouselRot % 360) + 360) % 360; 
            
            let activeIndex = Math.round(normalizedRot / angleStep) % projects.length;
            
            const cards = document.querySelectorAll('.project-card-3d');
            if (cards[activeIndex] && cards[activeIndex].dataset.revealed !== 'true') {
                cards[activeIndex].querySelectorAll('.card-solar-text').forEach(solarReveal);
                cards[activeIndex].dataset.revealed = 'true';
            }
        }
    }

    function initCarouselInteraction() {
        const carouselWrapper = document.querySelector('.carousel-3d-wrapper');
        if (!carouselWrapper) return;
        
        const startDrag = (e) => {
            isDraggingCarousel = true;
            dragDistanceCarousel = 0;
            startXCarousel = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            autoRotateCarousel = false;
            clearTimeout(autoRotateTimeout);
        };

        const moveDrag = (e) => {
            if (!isDraggingCarousel) return;
            if (e.cancelable && e.type.includes('touch')) e.preventDefault();
            
            const x = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            const walk = (x - startXCarousel) * 0.8; 
            
            carouselVelocity = walk * 0.6; 
            
            targetCarouselRot -= walk; 
            startXCarousel = x;
            dragDistanceCarousel += Math.abs(walk);
        };

        const endDrag = () => {
            if (!isDraggingCarousel) return;
            isDraggingCarousel = false;
            autoRotateTimeout = setTimeout(() => { autoRotateCarousel = true; }, 4000);
        };

        carouselWrapper.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', moveDrag, {passive: true});
        window.addEventListener('mouseup', endDrag);

        carouselWrapper.addEventListener('touchstart', startDrag, {passive: true});
        window.addEventListener('touchmove', moveDrag, {passive: false});
        window.addEventListener('touchend', endDrag);
    }

    const revealTimeouts = {};

    function updateHTMLSections() {
            if(!introCompleted) return;
            const sections = document.querySelectorAll('.section-3d');
            
            const isJumping = Math.abs(targetScrollZ - scrollZ) > 800;

            sections.forEach(sec => {
                const z = parseFloat(sec.dataset.z);
                const dist = z - scrollZ;
                
                if(dist > -800 && dist < 1200) {
                    if(sec.style.visibility !== 'visible') sec.style.visibility = 'visible'; 
                    
                    let opacity = 0, blur = 0, scale = 1;
                    
                    if(dist >= 0) {
                        const progress = 1 - (dist / 1200);
                        opacity = Math.pow(progress, 3); 
                        scale = 0.8 + (0.2 * progress);
                        blur = isJumping ? 0 : (1-progress) * 10; 
                    } else {
                        const progress = Math.abs(dist) / 800;
                        opacity = 1 - progress;
                        scale = 1 + progress;
                        blur = isJumping ? 0 : progress * 20;
                    }
                    
                    sec.style.opacity = opacity.toFixed(3);
                    sec.style.transform = `scale(${scale.toFixed(3)})`;
                    
                    if (blur > 0.5 && !isJumping) {
                        sec.style.filter = `blur(${blur.toFixed(1)}px)`;
                    } else {
                        sec.style.filter = 'none';
                    }
                    
                    if(opacity > 0.5) {
                        if (!sec.classList.contains('active-section')) sec.classList.add('active-section');
                        if(sec.dataset.revealed !== 'true') {
                            if (!revealTimeouts[z]) {
                                revealTimeouts[z] = setTimeout(() => {
                                    if (sec.classList.contains('active-section')) {
                                        sec.querySelectorAll('.solar-text:not(.card-solar-text)').forEach(solarReveal);
                                        sec.dataset.revealed = 'true';
                                        
                                        if (sec.id === 'work') {
                                            sec.querySelectorAll('.project-card-3d').forEach(c => c.dataset.revealed = 'false');
                                        }
                                    }
                                    revealTimeouts[z] = null;
                                }, 250); 
                            }
                        }
                    } else {
                        if (sec.classList.contains('active-section')) sec.classList.remove('active-section');
                        if (revealTimeouts[z]) {
                            clearTimeout(revealTimeouts[z]);
                            revealTimeouts[z] = null;
                        }
                    }
                } else {
                    if (sec.style.visibility !== 'hidden') {
                        sec.style.visibility = 'hidden';
                        sec.style.opacity = '0';
                        sec.style.filter = 'none';
                        sec.dataset.revealed = 'false';
                        sec.classList.remove('active-section');
                    }
                    if (revealTimeouts[z]) {
                        clearTimeout(revealTimeouts[z]);
                        revealTimeouts[z] = null;
                    }
                }
            });
        }

        function initScroll() {
            window.addEventListener('wheel', e => {
                if(!introCompleted || isDedicatedPageOpen) return; 
                const now = Date.now();
                if (now - lastScrollTime < scrollCooldown) return;
                if (Math.abs(e.deltaY) < 30) return;
                
                if(e.deltaY > 0 && targetScrollZ < maxScrollZ) {
                    targetScrollZ += sectionDistance;
                    lastScrollTime = now; SoundManager.playWarp();
                } else if(e.deltaY < 0 && targetScrollZ > 0) {
                    targetScrollZ -= sectionDistance;
                    lastScrollTime = now; SoundManager.playWarp();
                }
            }, { passive: true });

            window.addEventListener('keydown', e => {
                if(!introCompleted || isDedicatedPageOpen) return; 
                const now = Date.now();
                
                const workSec = document.getElementById('work');
                if(workSec && workSec.classList.contains('active-section')) {
                    if (e.key === 'ArrowRight') {
                        targetCarouselRot += (360 / projects.length);
                        SoundManager.playTick();
                        autoRotateCarousel = false;
                        clearTimeout(autoRotateTimeout);
                        autoRotateTimeout = setTimeout(() => { autoRotateCarousel = true; }, 4000);
                        return; 
                    }
                    if (e.key === 'ArrowLeft') {
                        targetCarouselRot -= (360 / projects.length);
                        SoundManager.playTick();
                        autoRotateCarousel = false;
                        clearTimeout(autoRotateTimeout);
                        autoRotateTimeout = setTimeout(() => { autoRotateCarousel = true; }, 4000);
                        return; 
                    }
                }

                if (now - lastScrollTime < scrollCooldown) return; 

                if(e.key === 'ArrowDown') { 
                    if(targetScrollZ < maxScrollZ) { 
                        targetScrollZ += sectionDistance; 
                        lastScrollTime = now; SoundManager.playWarp(); 
                    } 
                }
                if(e.key === 'ArrowUp') { 
                    if(targetScrollZ > 0) { 
                        targetScrollZ -= sectionDistance; 
                        lastScrollTime = now; SoundManager.playWarp(); 
                    } 
                }
            }, { passive: true });

            let touchStartY = 0;
            window.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, {passive: true});
            window.addEventListener('touchend', e => {
                if(!introCompleted || isDedicatedPageOpen) return; 
                const now = Date.now();
                if (now - lastScrollTime < scrollCooldown) return;

                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY - touchEndY;
                
                if(Math.abs(diff) > 50) {
                    if(diff > 0 && targetScrollZ < maxScrollZ) {
                        targetScrollZ += sectionDistance;
                        lastScrollTime = now; SoundManager.playWarp();
                    } else if(diff < 0 && targetScrollZ > 0) {
                        targetScrollZ -= sectionDistance;
                        lastScrollTime = now; SoundManager.playWarp();
                    }
                }
            }, { passive: true });
            
            const leftImg = document.querySelector('#service-img-left .service-img-inner');
            const rightImg = document.querySelector('#service-img-right .service-img-inner');
            const heroTitle = document.querySelector('.hero-shine-text');

            document.addEventListener('mousemove', (e) => {
                if (window.innerWidth < 768) return;
                const x = (e.clientX / window.innerWidth - 0.5) * 2; 
                const y = (e.clientY / window.innerHeight - 0.5) * 2; 
                
                document.documentElement.style.setProperty('--mx', x);
                document.documentElement.style.setProperty('--my', y);

                if (leftImg && rightImg) {
                    leftImg.style.transform = `perspective(1000px) rotateY(${x * 12}deg) rotateX(${-y * 12}deg) translateZ(25px)`;
                    rightImg.style.transform = `perspective(1000px) rotateY(${x * 12}deg) rotateX(${-y * 12}deg) translateZ(25px)`;
                }

                if (heroTitle) {
                    heroTitle.style.transform = `translate3d(${x * 15}px, ${y * 15}px, 0)`;
                }
            }, { passive: true });
        }

        window.scrollToSection = (z) => {
            targetScrollZ = z;
            SoundManager.playWarp();
        };

        window.toggleService = (el) => {
            SoundManager.playClick();
            const desc = el.querySelector('.service-desc');
            const isOpen = desc.style.maxHeight;
            
            document.querySelectorAll('.service-desc').forEach(d => { d.style.maxHeight = null; d.style.opacity = 0; });
            
            const siblings = Array.from(el.parentNode.children).filter(child => child.nodeType === 1); 
            const index = siblings.indexOf(el);

            const imgL = document.querySelector('#service-img-left img');
            const imgR = document.querySelector('#service-img-right img');
            const contL = document.getElementById('service-img-left');
            const contR = document.getElementById('service-img-right');
            const innerL = contL ? contL.querySelector('.service-img-inner img') : null;
            const innerR = contR ? contR.querySelector('.service-img-inner img') : null;

            if(!isOpen) {
                desc.style.maxHeight = desc.scrollHeight + "px";
                desc.style.opacity = 1;
                solarReveal(desc.querySelector('.solar-text'));

                if (contL && contR && serviceImagesData[index]) {
                    if(innerL) innerL.src = serviceImagesData[index][0];
                    if(innerR) innerR.src = serviceImagesData[index][1];
                    
                    contL.classList.remove('holo-active'); contR.classList.remove('holo-active');
                    void contL.offsetWidth; 
                    contL.classList.add('holo-active'); contR.classList.add('holo-active');
                    
                    contL.style.opacity = 1; contR.style.opacity = 1;
                    SoundManager.playWarp();
                }
            } else {
                if (contL && contR) {
                    contL.classList.remove('holo-active'); contR.classList.remove('holo-active');
                    contL.style.opacity = 0; contR.style.opacity = 0;
                }
            }
        };

        window.addEventListener('load', () => {
            if (typeof emailjs !== 'undefined') {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }

            lucide.createIcons();
            initThreeJS();
            initCarousel();
            initCarouselInteraction(); 
            initScroll();
            initDualCursor();
            initMagneticButtons();
            
            const btn = document.getElementById('hamburger-btn');
            const menu = document.getElementById('mobile-menu');
            btn.onclick = () => {
                SoundManager.playClick();
                menu.classList.toggle('open');
                btn.classList.toggle('open');
                btn.setAttribute('aria-expanded', btn.classList.contains('open'));
                
                if(menu.classList.contains('open')) {
                    menu.querySelectorAll('.mobile-link').forEach((link, i) => {
                        setTimeout(() => solarReveal(link), i * 100);
                    });
                }
            };
            
            menu.querySelectorAll('.mobile-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    menu.classList.remove('open'); btn.classList.remove('open');
                    btn.setAttribute('aria-expanded', 'false');
                    window.scrollToSection(parseInt(link.dataset.navTo));
                };
            });

            let p = 0;
            const bar = document.getElementById('loader-bar');
            const txt = document.getElementById('loader-percent');
            const interval = setInterval(() => {
                p += Math.floor(Math.random() * 5);
                if(p > 100) p = 100;
                bar.style.width = p + "%";
                txt.innerText = p + "%";
                if(p === 100) {
                    clearInterval(interval);
                    document.getElementById('preloader').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('preloader').style.display = 'none';
                        document.getElementById('isekai-modal').classList.add('active');
                        solarReveal(document.getElementById('isekai-text'));
                        setTimeout(() => { solarReveal(document.getElementById('enter-world-btn')); }, 1200);
                    }, 800);
                }
            }, 30);
            
            document.getElementById('enter-world-btn').addEventListener('click', () => {
                SoundManager.init();
                SoundManager.playSupernova(); SoundManager.playAmbient();   
                
                const flash = document.getElementById('flash-overlay');
                flash.style.display = 'block'; flash.style.opacity = 1;
                document.getElementById('isekai-modal').classList.remove('active');
                
                setTimeout(() => {
                    introCompleted = true;
                    document.getElementById('main-nav').style.opacity = 1;

                    updateHTMLSections();
                    
                    const hero = document.querySelector('.section-3d[data-z="0"]');
                    hero.querySelectorAll('.solar-text').forEach(solarReveal);
                    
                    flash.style.transition = "opacity 0.8s ease-out";
                    flash.style.opacity = 0;
                    setTimeout(() => flash.style.display = 'none', 800);
                }, 100);
            });

            document.getElementById('close-contact').onclick = () => document.getElementById('contact-modal').classList.remove('open');
            document.querySelectorAll('.open-contact-btn').forEach(btn => {
                btn.onclick = () => document.getElementById('contact-modal').classList.add('open');
            });

            document.getElementById('btn-back-page').addEventListener('click', () => {
                SoundManager.playClick();
                isDedicatedPageOpen = false; 
                const page = document.getElementById('dedicated-page');
                const pageVideo = document.getElementById('page-video');
                const pageIframe = document.getElementById('page-iframe');
                
                page.style.opacity = 0;
                page.style.pointerEvents = 'none';
                page.setAttribute('aria-hidden', 'true');
                
                applyTheme('default');
                SoundManager.stopThemeMusic();
                EclipseFX.stop(); 
                if(pageVideo) pageVideo.pause();
                if(pageIframe) pageIframe.src = ""; 

                setTimeout(() => {
                    page.style.display = 'none';
                    page.classList.add('hidden');
                }, 700);
            });

            document.getElementById('show-form-btn').addEventListener('click', function() {
                SoundManager.playClick();
                const formContainer = document.getElementById('project-form-container');
                
                this.style.opacity = 0;
                this.style.pointerEvents = 'none';
                
                setTimeout(() => {
                    document.getElementById('btn-container-reveal').style.display = 'none'; 
                    
                    formContainer.classList.remove('hidden');
                    formContainer.classList.add('flex');
                    void formContainer.offsetWidth; 
                    formContainer.style.opacity = 1;
                    lucide.createIcons(); 
                    
                    formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 400);
            });

            document.getElementById('close-form-btn').addEventListener('click', function() {
                SoundManager.playClick();
                const formContainer = document.getElementById('project-form-container');
                const btnContainer = document.getElementById('btn-container-reveal');
                const showFormBtn = document.getElementById('show-form-btn');
                
                formContainer.style.opacity = 0;
                
                setTimeout(() => {
                    formContainer.classList.add('hidden');
                    formContainer.classList.remove('flex');
                    
                    btnContainer.style.display = 'flex';
                    void showFormBtn.offsetWidth; 
                    showFormBtn.style.opacity = 1;
                    showFormBtn.style.pointerEvents = 'auto';
                    
                    btnContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 400);
            });

            document.getElementById('dp-submit').addEventListener('click', function() {
                SoundManager.playClick();

                const collection = document.getElementById('page-title').innerText;
                const name = document.getElementById('dp-name').value;
                const size = document.getElementById('dp-size').value;
                const color = document.getElementById('dp-color').value;
                const msg = document.getElementById('dp-msg').value;

                if (!name || !size || !color || !msg) {
                    alert("Por favor, preencha todos os campos para prosseguir.");
                    return;
                }

                this.innerText = "A TRANSMITIR...";
                this.style.backgroundColor = "#fff";
                this.style.color = "#000";

                if(SoundManager.playSupernova) SoundManager.playSupernova();

                const templateParams = {
                    collection: collection,
                    from_name: name,
                    size: size,
                    color: color,
                    message: msg
                };

                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                    .then(() => {
                        this.innerText = "PEDIDO ENVIADO ✓";
                        document.getElementById('hud-status').innerText = "TRANSMISSÃO CONCLUÍDA";
                        document.getElementById('hud-status').style.color = "var(--accent)";

                        setTimeout(() => {
                            isDedicatedPageOpen = false;

                            const flash = document.getElementById('flash-overlay');
                            if (flash) {
                                flash.style.display = 'block'; void flash.offsetWidth;
                                flash.style.transition = 'opacity 0.05s ease-out'; flash.style.opacity = 1;
                            }

                            const page = document.getElementById('dedicated-page');
                            const pageVideo = document.getElementById('page-video');
                            const pageIframe = document.getElementById('page-iframe');
                            page.style.opacity = 0;
                            
                            setTimeout(() => {
                                if(flash) { flash.style.transition = "opacity 1.0s ease-in-out"; flash.style.opacity = 0; }
                                applyTheme('default');
                                SoundManager.stopThemeMusic();
                                EclipseFX.stop();
                                if(pageVideo) pageVideo.pause();
                                if(pageIframe) pageIframe.src = ""; 
                            }, 100);

                            setTimeout(() => {
                                page.style.display = 'none';
                                page.classList.add('hidden');
                                page.setAttribute('aria-hidden', 'true');
                                if(flash) flash.style.display = 'none';

                                this.innerText = "Solicitar Criação";
                                this.style.backgroundColor = "";
                                this.style.color = "";
                                document.getElementById('hud-status').innerText = "INATIVO";
                                document.getElementById('hud-status').style.color = "";

                            }, 1500); 
                        }, 1200);
                    })
                    .catch((error) => {
                        console.error('Falha no envio:', error);
                        this.innerText = "ERRO NA TRANSMISSÃO";
                        setTimeout(() => {
                            this.innerText = "Solicitar Criação";
                            this.style.backgroundColor = "";
                            this.style.color = "";
                        }, 3000);
                    });
            });

            document.getElementById('submit-whatsapp').addEventListener('click', function() {
                SoundManager.playClick();

                const name = document.getElementById('form-name').value;
                const email = document.getElementById('form-email').value;
                const msg = document.getElementById('form-msg').value;

                if (!name || !email || !msg) {
                    alert("Por favor, preencha todos os campos.");
                    return;
                }

                this.innerText = "A TRANSMITIR...";
                this.style.backgroundColor = "#fff";
                this.style.color = "#000";

                if(SoundManager.playSupernova) SoundManager.playSupernova();

                const templateParams = {
                    from_name: name,
                    reply_to: email,
                    message: msg
                };

                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                    .then(() => {
                        this.innerText = "AGENDAMENTO SOLICITADO ✓";
                        document.getElementById('hud-status').innerText = "TRANSMISSÃO CONCLUÍDA";
                        document.getElementById('hud-status').style.color = "var(--accent)";

                        setTimeout(() => {
                            const flash = document.getElementById('flash-overlay');
                            if (flash) {
                                flash.style.display = 'block'; void flash.offsetWidth;
                                flash.style.transition = 'opacity 0.05s ease-out'; flash.style.opacity = 1;
                            }

                            document.getElementById('contact-modal').classList.remove('open');
                            
                            const viewport = document.getElementById('viewport'); if(viewport) viewport.style.opacity = '0';
                            const nav = document.getElementById('main-nav'); if(nav) nav.style.opacity = '0';
                            const footer = document.getElementById('footer-section'); if(footer) footer.style.opacity = '0';
                            const hudNav = document.getElementById('hud-nav'); if(hudNav) hudNav.style.opacity = '0';

                            setTimeout(() => {
                                if(flash) { flash.style.transition = "opacity 1.0s ease-in-out"; flash.style.opacity = 0; }
                            }, 100);

                            setTimeout(() => {
                                window.scrollToSection(0);
                                if(viewport) viewport.style.opacity = '1';
                                if(nav) nav.style.opacity = '1';
                                if(footer) footer.style.opacity = '1';
                                if(hudNav) {
                                    hudNav.style.opacity = '1';
                                    hudNav.classList.remove('opacity-0', 'pointer-events-none');
                                }
                                if(flash) flash.style.display = 'none';

                                const navLinks = document.getElementById('nav-links');
                                const navCta = document.getElementById('nav-cta');
                                if(navLinks) {
                                    navLinks.classList.remove('opacity-0', 'pointer-events-none');
                                    navLinks.querySelectorAll('.solar-text').forEach(solarReveal);
                                }
                                if(navCta) {
                                    navCta.classList.remove('opacity-0', 'pointer-events-none');
                                    solarReveal(navCta);
                                }

                                this.innerText = "Solicitar Agendamento";
                                this.style.backgroundColor = "";
                                this.style.color = "";
                                document.getElementById('hud-status').innerText = "INATIVO";
                                document.getElementById('hud-status').style.color = "";

                            }, 1500); 
                        }, 1200);
                    })
                    .catch((error) => {
                        console.error('Falha no envio:', error);
                        this.innerText = "ERRO NA TRANSMISSÃO";
                        setTimeout(() => {
                            this.innerText = "Solicitar Agendamento";
                            this.style.backgroundColor = "";
                            this.style.color = "";
                        }, 3000);
                    });
            });
        });
    </script>
</body>
</html>